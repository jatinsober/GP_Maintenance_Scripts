------
--DEV BY : Jitendra Lodwal  
--DATE  : 25-AUG-2011 
--DESC : FUNCTION
------
SET SEARCH_PATH TO WORKAREA;
CREATE OR REPLACE FUNCTION Mep_Cps_Daily_Rawdata_Load(CURR_PROCESS_DATE IN DATE) RETURNS VOID AS $$
DECLARE
P_RPT_DT DATE;
BILL_DATE         TEMP_BILL_CYC.BILL_DATE%TYPE;
BEGIN
P_RPT_DT := CURR_PROCESS_DATE; -- REPORT DATE
BEGIN

TRUNCATE TABLE MEP_CARD_DETAIL;
INSERT INTO MEP_CARD_DETAIL(CD_CYC_DT,CB_INDIVIDUAL_ACCTNO,CB_BASIC_SUPP_IND,CB_BILL_CYCLE,CB_AUTOPAY_IND,CB_ANNIV_DATE,
CB_PLASTIC_CD,CB_PLASTIC_DATE,CB_USER_CODE_1,CB_STATUS_CD,CB_NPL_STATUS,CB_ACC_CLOSE_DATE,CB_CRLIMIT_CHG_DATE,
CB_CHARGE_OFF_DATE,CB_WATCHLIST,CB_WATCH_DATE,CB_BASIC_CARDHOLDER_NO,CB_CARDHOLDER_NO,CB_FEE_CD)
SELECT
CD_CYC_DT,CB_INDIVIDUAL_ACCTNO,CB_BASIC_SUPP_IND,CB_BILL_CYCLE,CB_AUTOPAY_IND,CB_ANNIV_DATE,
CB_PLASTIC_CD,CB_PLASTIC_DATE,CB_USER_CODE_1,CB_STATUS_CD,CB_NPL_STATUS,CB_ACC_CLOSE_DATE,CB_CRLIMIT_CHG_DATE,
CB_CHARGE_OFF_DATE,CB_WATCHLIST,CB_WATCH_DATE,CB_BASIC_CARDHOLDER_NO,CB_CARDHOLDER_NO,CB_FEE_CD
FROM dwprod_base.CARD_DETAIL
WHERE CD_CYC_DT = P_RPT_DT
AND   LPAD(CB_BILL_CYCLE,2,0) = TO_CHAR(P_RPT_DT,'DD');
--COMMIT;

TRUNCATE TABLE MEP_CARD_ACCT_DETAIL;
INSERT INTO MEP_CARD_ACCT_DETAIL
SELECT * FROM  dwprod_base.CARD_ACCT_DETAIL
WHERE CAD_CYC_DT = P_RPT_DT;
--COMMIT;
TRUNCATE TABLE MEP_CARD_FIN;
INSERT INTO  MEP_CARD_FIN(CB_FIN_ACCTNO,CB_PRODUCT_CD,CB_CURMTH_BAL,CB_30DAYS_BAL,
CB_60DAYS_BAL,CB_90DAYS_BAL,CB_MTD_TOT_CHRG_AMT,
CB_LAST_PAYMENT_AMT,CB_LAST_AGE_CD,CF_CYC_DT,CB_LAST_PAYMENT_DATE,
CB_EXCESS_LMT_IND,CB_ACRU_EXCESS,CB_ACRU_CRBAL_INT)
SELECT
CB_FIN_ACCTNO,CB_PRODUCT_CD,CB_CURMTH_BAL,CB_30DAYS_BAL,
CB_60DAYS_BAL,CB_90DAYS_BAL,CB_MTD_TOT_CHRG_AMT,
CB_LAST_PAYMENT_AMT,CB_LAST_AGE_CD,CF_CYC_DT,CB_LAST_PAYMENT_DATE,
CB_EXCESS_LMT_IND,CB_ACRU_EXCESS,CB_ACRU_CRBAL_INT
FROM dwprod_base.CARD_FIN
--WHERE TO_DATE(CF_CYC_CYCLE,'DD') = P_RPT_DT;
WHERE  CF_CYC_DT = P_RPT_DT;
--COMMIT;


TRUNCATE TABLE MEP_TRAN_CPS_DLY;
INSERT INTO MEP_TRAN_CPS_DLY(TXD_ACCT_ID, TXD_ACCT_NO,TXD_CASH_AMT,TXD_TRAN_DT)
SELECT  TXD_ACCT_ID,TXD_ACCT_NO,SUM(COALESCE(TXD_CASH_AMT,0)) AS TXD_CASH_AMT,TXD_TRAN_DT
FROM dwprod_base.TRAN_DETAIL
WHERE TXD_APPL_SYS_ID = 'CPS'
AND   TXD_TRAN_CD IN ('PATM', 'PBRCHCH', 'PBRCHML', 'PPHONE', 'PAUTO', 'TOPUPMERC',
'PMTBII', 'PBRCHCQ', 'RPATM', 'RTOPUPMERC', 'RPBRCHML', 'RPBRCHCQ', 'RPPHONE', 'RPAUTO',
'RPBRCHCH' , 'RSALEIPM')
AND   TXD_TRAN_DT = P_RPT_DT
GROUP BY TXD_ACCT_ID,TXD_ACCT_NO,TXD_TRAN_DT;
--COMMIT;

END;
END;
$$
LANGUAGE PLPGSQL;
