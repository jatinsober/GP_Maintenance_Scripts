------
--DEV BY : Jitendra Lodwal  
--DATE  : 26-AUG-2011 
--DESC : FUNCTION
------

SET SEARCH_PATH TO WORKAREA;

CREATE OR REPLACE FUNCTION ACCT_NOT_LINK (RPT_DT IN DATE) RETURNS VOID AS $$
DECLARE
RPT_DT2 DATE ;

BEGIN

Truncate table BNM_ACCT_RED ;
Truncate table BNM_CAR_RED;
Truncate table BNM_ACCT_NOT_LINK_RED ;

RPT_DT2 := RPT_DT;


insert into BNM_ACCT_RED
select  ACCT_APPL_SYS_ID, ACCT_SUB_TYP_ID, ACCT_ACCT_NO, ACCT_ACCT_ID, ACCT_CUR_BAL, ACCT_STAT_CD, ACCT_NA_TRLR_LINE1,
ACCT_NA_TRLR_LINE2, ACCT_NA_TRLR_LINE3,ACCT_NA_TRLR_LINE4, ACCT_NA_TRLR_LINE5, ACCT_POSTCODE,ACCT_PROD_CD,ACCT_BUS_CYC_DT, ACCT_OPEN_DT as REPORT_DATE
from DWPROD.ACCT_HT
where ACCT_APPL_SYS_ID in ('STS','IMS')
AND ACCT_BUS_CYC_DT= RPT_DT2;

INSERT into BNM_CAR_RED
(CAR_C_CIF_NO,CAR_PRIMARY_ID,CAR_PRIME_NO,CAR_A_ACCT_NO,CAR_R_ACCT_ID,CAR_CUST_KEY,CAR_REL_TYP_CD,CAR_EXPIRATION_DT,REPORT_DATE)
SELECT CAR_C_CIF_NO,CAR_PRIMARY_ID,CAR_PRIME_NO,CAR_A_ACCT_NO,CAR_R_ACCT_ID,CAR_CUST_KEY,CAR_REL_TYP_CD,CAR_EXPIRATION_DT,CAR_BUS_CYC_DT as REPORT_DATE
FROM DWPROD.CUST_ACCT_REL_HT
WHERE CAR_A_APPL_SYS_ID  IN ('STS', 'IMS')
AND CAR_BUS_CYC_DT= RPT_DT2;


DELETE FROM BNM_ACCT_RED
WHERE ACCT_APPL_SYS_ID='STS'
AND ACCT_STAT_CD IN ('03','04','05');
--COMMIT;

DELETE FROM BNM_ACCT_RED
WHERE ACCT_APPL_SYS_ID='IMS'
AND ACCT_STAT_CD IN ('03','04','05','08');
--COMMIT;


INSERT INTO BNM_ACCT_NOT_LINK_RED
SELECT * FROM BNM_ACCT_RED A
WHERE NOT EXISTS
(SELECT DISTINCT CAR_R_ACCT_ID
FROM BNM_CAR_RED C, BNM_ACCT_RED A
WHERE A.ACCT_ACCT_ID=C.CAR_R_ACCT_ID);

END;
$$
LANGUAGE PLPGSQL;

