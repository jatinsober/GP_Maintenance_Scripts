------
--Dev: Jitendra Lodwal
--Date: 26/09/2011
--Desc: Function
------

SET SEARCH_PATH TO RISK;

CREATE OR REPLACE FUNCTION Check_All_Bus_Date( FILE_NAME IN VARCHAR,EXT_TABLE IN VARCHAR,BUS_DATE_FD IN VARCHAR,APPL_ID IN VARCHAR) RETURNS VOID AS $$
	   
DECLARE
ROW_NUM NUMERIC;
	   COMMENT_DESC VARCHAR(500);
	   BUS_DATE_VAL VARCHAR(20);
EXT_TABLE1 RECORD;
BUS_DATE_FD1 RECORD;

BEGIN
EXT_TABLE1 := EXT_TABLE;
	SELECT COUNT(DISTINCT '|| BUS_DATE_FD||') ||' INTO ROW_NUM FROM '||EXT_TABLE1 ;
	 IF(ROW_NUM > 1) THEN
	    /*ERROR BCOS COUNT(DATE EXTRACT) > 1*/
		COMMENT_DESC := 'ERROR: MORE THAN 1 BUSINESS DATE EXIST IN THIS SOURCE FILE';

	 ELSIF(ROW_NUM = 1) THEN
	    /*OK*/
		COMMENT_DESC := 'SOURCE FILE IS OK';
SELECT COUNT(DISTINCT '|| BUS_DATE_FD||') ||' INTO BUS_DATE_VAL FROM '||EXT_TABLE1 ;		

	 ELSE
	    /*ERROR BCOS BLANK SOURCE FILE*/
		COMMENT_DESC := 'ERROR: SOURCE FILE DO NOT CONTAIN ANY DATA';
		
	 END IF;
	 /*LOAD INTO ADM_SOURCE_INFO*/
     IF(TRIM(APPL_ID) = 'SIE') THEN
		 INSERT INTO ADM_SOURCE_INFO
		 (ASI_FILE, ASI_EXT_TABLE, ASI_BUS_DATE, ASI_BUS_DATE_FIELD, ASI_APPL_ID, ASI_COMMENT)
		 VALUES(FILE_NAME, EXT_TABLE1, TO_DATE(BUS_DATE_VAL,'YYYYMMDD'), BUS_DATE_FD, APPL_ID, COMMENT_DESC);
     ELSIF(TRIM(APPL_ID) = 'CRMS') THEN
		 INSERT INTO ADM_SOURCE_INFO
		 (ASI_FILE, ASI_EXT_TABLE, ASI_BUS_DATE, ASI_BUS_DATE_FIELD, ASI_APPL_ID, ASI_COMMENT)
		 VALUES(FILE_NAME, EXT_TABLE1, TO_DATE(BUS_DATE_VAL,'MMDDYYYY'), BUS_DATE_FD, APPL_ID, TRIM(COMMENT_DESC));
     ELSIF(TRIM(APPL_ID) = 'RISKWATCH') THEN
		 INSERT INTO ADM_SOURCE_INFO
		 (ASI_FILE, ASI_EXT_TABLE, ASI_BUS_DATE, ASI_BUS_DATE_FIELD, ASI_APPL_ID, ASI_COMMENT)
		 VALUES(FILE_NAME, EXT_TABLE1, TO_DATE(BUS_DATE_VAL,'YYYYMMDD'), BUS_DATE_FD, APPL_ID, TRIM(COMMENT_DESC));
	 ELSE
		 INSERT INTO ADM_SOURCE_INFO
		 (ASI_FILE, ASI_EXT_TABLE, ASI_BUS_DATE, ASI_BUS_DATE_FIELD, ASI_APPL_ID, ASI_COMMENT)
		 VALUES(FILE_NAME, EXT_TABLE, TO_DATE(BUS_DATE_VAL,'YYYYMMDD'), BUS_DATE_FD, APPL_ID, COMMENT_DESC);
	 END IF;
EXCEPTION
	 WHEN OTHERS THEN
	 /*INCORRECT SOURCE FILE FORMAT*/
	    COMMENT_DESC := '-1,error';
	 /*LOAD INTO ADM_SOURCE_INFO*/
	    INSERT INTO ADM_SOURCE_INFO
	    (ASI_FILE, ASI_EXT_TABLE, ASI_BUS_DATE_FIELD, ASI_APPL_ID, ASI_COMMENT)
	    VALUES(FILE_NAME, EXT_TABLE, BUS_DATE_FD, APPL_ID, COMMENT_DESC);

END;
$$
LANGUAGE PLPGSQL;
