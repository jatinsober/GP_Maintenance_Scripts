------
--DEV BY : Jitendra Lodwal  
--DATE  : 25-AUG-2011 
--DESC : FUNCTION
------

SET SEARCH_PATH TO WORKAREA;

CREATE OR REPLACE FUNCTION Kpi_Insert_Data2() RETURNS VOID AS $$

DECLARE
err_num KPI_ERROR_LOG.ERROR_NO%TYPE;
err_msg KPI_ERROR_LOG.ERROR_MSG%TYPE;
err_table KPI_ERROR_LOG.ERROR_TABLE%TYPE;
err_date KPI_ERROR_LOG.ERROR_DATE%TYPE;

BEGIN

-- /***** INSERT RECORDS INTO CUST_ACCTGROUPBY3*****/

TRUNCATE TABLE CUST_ACCTGROUPBY3;

err_table :='INSERT RECORDS INTO CUST_ACCTGROUPBY3';

INSERT INTO CUST_ACCTGROUPBY3
SELECT A.CUST_KEY, A.APPL_SYS_ID, A.PROD_CD
FROM CUST_ACCT A
WHERE A.APPL_SYS_ID = 'GEN' AND 
COALESCE(A.ACCT_STATUS_CD,'$$') NOT IN ('RD','RH','SU');

err_table :='INSERT RECORDS INTO CUST_ACCTGROUPBY3';

INSERT INTO CUST_ACCTGROUPBY3
SELECT A.CUST_KEY, A.APPL_SYS_ID, A.PROD_CD
FROM CUST_ACCT A
WHERE A.APPL_SYS_ID = 'ICS' AND 
COALESCE(A.ACCT_STATUS_CD,'$$') NOT IN ('C','E','Y');
err_table :='INSERT RECORDS INTO CUST_ACCTGROUPBY3';

INSERT INTO CUST_ACCTGROUPBY3
SELECT A.CUST_KEY, A.APPL_SYS_ID, A.PROD_CD
FROM CUST_ACCT A
WHERE A.APPL_SYS_ID = 'IMS' AND 
COALESCE(A.ACCT_STATUS_CD,'$$') NOT IN ('03','04','05','08');
err_table :='INSERT RECORDS INTO CUST_ACCTGROUPBY3';

INSERT INTO CUST_ACCTGROUPBY3
SELECT A.CUST_KEY, A.APPL_SYS_ID, A.PROD_CD
FROM CUST_ACCT A
WHERE A.APPL_SYS_ID = 'LIF' AND 
COALESCE(A.ACCT_STATUS_CD,'$$') <> 'T0';
err_table :='INSERT RECORDS INTO CUST_ACCTGROUPBY3';

INSERT INTO CUST_ACCTGROUPBY3
SELECT A.CUST_KEY, A.APPL_SYS_ID, A.PROD_CD
FROM CUST_ACCT A
WHERE A.APPL_SYS_ID = 'STS' AND 
COALESCE(A.ACCT_STATUS_CD,'$$') NOT IN ('03','04','05');
INSERT INTO CUST_ACCTGROUPBY3
SELECT A.CUST_KEY, A.APPL_SYS_ID, A.PROD_CD
FROM CUST_ACCT A
WHERE A.APPL_SYS_ID NOT IN ('GEN','ICS','IMS','LIF','STS');
err_table :='INSERT RECORDS INTO CUST_ACCTGROUPBY3';

TRUNCATE TABLE CUST_MASSAGE3;
err_table :='INSERT RECORDS INTO CUST_MASSAGE3';
INSERT INTO CUST_MASSAGE3
SELECT A.CUST_KEY, B.CUS_TYP_CD, B.FIVE_GROUP, B.TEN_GROUP, A.APPL_SYS_ID, B.CUS_EMP_FLAG, A.PROD_CD
FROM CUST_ACCTGROUPBY3 A, CUST_AGE B
WHERE A.CUST_KEY = B.CUST_KEY
GROUP BY A.CUST_KEY, B.CUS_TYP_CD, B.FIVE_GROUP, B.TEN_GROUP, A.APPL_SYS_ID, B.CUS_EMP_FLAG, A.PROD_CD
ORDER BY A.CUST_KEY;

TRUNCATE TABLE CUST2F;

err_table :='INSERT RECORDS INTO CUST2F';

INSERT INTO CUST2F 
SELECT A.APPL_SYS_ID, A.CUS_TYP_CD, A.FIVE_GROUP, A.TEN_GROUP, COUNT(A.CUST_KEY), A.PROD_CD, B.PROD_LONG_DESC
FROM CUST_MASSAGE3 A, DWPROD.PRODUCT B
WHERE A.PROD_CD = B.PROD_PROD_CD
AND   A.APPL_SYS_ID=PROD_APPL_SYS_ID 
AND PROD_FIN_INST_NO ='001'
GROUP BY A.APPL_SYS_ID, A.CUS_TYP_CD, A.FIVE_GROUP, A.TEN_GROUP, A.PROD_CD, B.PROD_LONG_DESC;

TRUNCATE TABLE KPI_NEWCUST_BY_AGE;
err_table :='INSERT RECORDS INTO CUST2F';

INSERT INTO KPI_NEWCUST_BY_AGE
SELECT B.APPL_SYS_ID ,A.TEN_GROUP,
COUNT (DISTINCT A.CUST_KEY)
FROM CUST_AGE A,CUST_ACCT B
WHERE (A.CUST_KEY = B.CUST_KEY
AND TRIM(TO_CHAR(B.ACCT_OPEN_DT, 'MMYYYY')) = (SELECT DISTINCT TRIM(TO_CHAR(SC_CURR_CYC,'MMYYYY')) 
FROM DWPROD.SSYSCYC WHERE  SC_FREQUENCY='M'))
GROUP BY (B.APPL_SYS_ID,A.TEN_GROUP);

TRUNCATE TABLE KPI_NEWCUST_BY_RACE;
err_table :='INSERT RECORDS INTO CUST2F';

INSERT INTO KPI_NEWCUST_BY_RACE
SELECT B.APPL_SYS_ID ,A.ETHNIC_IND_CD,COUNT (DISTINCT A.CUST_KEY)
FROM CUST_INFO A,CUST_ACCT B
WHERE (A.CUST_KEY = B.CUST_KEY
AND TRIM(TO_CHAR(B.ACCT_OPEN_DT, 'MMYYYY')) = (SELECT DISTINCT TRIM(TO_CHAR (SC_CURR_CYC,'MMYYYY')) 
FROM DWPROD.SSYSCYC WHERE  SC_FREQUENCY='M'))
GROUP BY (B.APPL_SYS_ID,A.ETHNIC_IND_CD);

TRUNCATE TABLE KPI_NEWCUST_BY_PROD;
err_table :='INSERT RECORDS INTO CUST2F';

INSERT INTO KPI_NEWCUST_BY_PROD
SELECT APPL_SYS_ID, COUNT(DISTINCT CUST_KEY)
FROM CUST_ACCT
WHERE TRIM(TO_CHAR(ACCT_OPEN_DT, 'MMYYYY')) = (SELECT DISTINCT TRIM(TO_CHAR (SC_CURR_CYC,'MMYYYY')) FROM DWPROD.SSYSCYC WHERE  SC_FREQUENCY='M')
GROUP BY APPL_SYS_ID;

EXCEPTION
   WHEN OTHERS THEN
      err_num := -1;
      err_msg := SUBSTR('error', 1, 100);
	  err_date := LOCALTIMESTAMP;
      INSERT INTO KPI_ERROR_LOG VALUES (err_num, err_msg,err_table,err_date);
END;

$$
LANGUAGE PLPGSQL;