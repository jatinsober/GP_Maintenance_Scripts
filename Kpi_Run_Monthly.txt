------
--DEV BY : Jitendra Lodwal  
--DATE  : 25-AUG-2011 
--DESC : FUNCTION
------

SET SEARCH_PATH TO WORKAREA;

CREATE OR REPLACE FUNCTION Kpi_Run_Monthly() RETURNS VOID AS $$

DECLARE
err_num KPI_ERROR_LOG.ERROR_NO%TYPE;
   err_msg KPI_ERROR_LOG.ERROR_MSG%TYPE;
   err_table KPI_ERROR_LOG.ERROR_TABLE%TYPE;
   err_date KPI_ERROR_LOG.ERROR_DATE%TYPE;

BEGIN

----/***** INSERT RECORDS INTO CUST_INFO*****/
TRUNCATE TABLE CUST_INFO;
err_table :='INSERT RECORDS INTO CUST_INFO';
INSERT INTO CUST_INFO
				 		SELECT A.PER_CUST_KEY,A.PER_SEX_CD,A.PER_MARIT_STAT_CD,A.PER_RELIGIOUS_CODE,A.PER_ETHNIC_IND_CD,A.PER_CUST_OCCUP_CD,A.PER_RENT_OWN_IND, A.PER_BUS_CYC_DT
							   FROM DWPROD.CUST_PERS_HT A
							   		WHERE (A.PER_BUS_CYC_DT = (SELECT DISTINCT SC_CURR_CYC FROM DWPROD.SSYSCYC WHERE SC_FREQUENCY='M'));



----/***** INSERT RECORDS INTO CUST_ACCTGROUPBY1*****/
TRUNCATE TABLE CUST_ACCTGROUPBY1;
err_table :='INSERT RECORDS INTO CUST_ACCTGROUPBY1';
				 INSERT INTO CUST_ACCTGROUPBY1
				 		SELECT CUST_KEY, APPL_SYS_ID, NULL
							   FROM CUST_ACCT
							   		GROUP BY CUST_KEY, APPL_SYS_ID
										  ORDER BY CUST_KEY;


----/***** UPDATE RECORDS INTO CUST_ACCTGROUPBY1*****/
err_table :='UPDATE RECORDS INTO CUST_ACCTGROUPBY1';
		 UPDATE CUST_ACCTGROUPBY1 
SET APP_CODE =(SELECT B.APP_CODE FROM CP_APP_CODE_TABLE B,  CUST_ACCTGROUPBY1 
WHERE CUST_ACCTGROUPBY1.APPL_SYS_ID =  B.CAR_A_APPL_SYS_ID);

--/***** INSERT RECORDS INTO CUST_ACCTGROUPBY2*****/
TRUNCATE TABLE CUST_ACCTGROUPBY2;
err_table :='INSERT RECORDS INTO CUST_ACCTGROUPBY2';
				 INSERT INTO CUST_ACCTGROUPBY2
				 		SELECT CUST_KEY, APPL_SYS_ID, NULL, SUM(CUR_BAL), COUNT(ACCT_NO)
							  FROM CUST_ACCT
							   	   WHERE PRIMARY_IND = 'Y'
								   		 GROUP BY CUST_KEY, APPL_SYS_ID
										 	   ORDER BY CUST_KEY;

--/***** UPDATE RECORDS INTO CUST_ACCTGROUPBY2*****/
err_table :='UPDATE RECORDS INTO CUST_ACCTGROUPBY2';
				 UPDATE CUST_ACCTGROUPBY2
SET APP_CODE =(SELECT B.APP_CODE FROM CP_APP_CODE_TABLE B,  CUST_ACCTGROUPBY2 
WHERE CUST_ACCTGROUPBY2.APPL_SYS_ID =  B.CAR_A_APPL_SYS_ID);





--/***** INSERT RECORDS INTO CUST_MASSAGE1*****/

TRUNCATE TABLE CUST_MASSAGE1;
err_table :='INSERT RECORDS INTO CUST_MASSAGE1';
				 INSERT INTO CUST_MASSAGE1
				 		SELECT A.CUST_KEY, SUM(A.APP_CODE), B.CUS_TYP_CD, B.FIVE_GROUP, B.TEN_GROUP, NULL, NULL,B.CUS_EMP_FLAG
							   FROM CUST_ACCTGROUPBY1 A, CUST_AGE B
							   		WHERE A.CUST_KEY = B.CUST_KEY
										  GROUP BY A.CUST_KEY, B.CUS_TYP_CD, B.FIVE_GROUP, B.TEN_GROUP,B.CUS_EMP_FLAG
										  		ORDER BY A.CUST_KEY;

--/***** UPDATE RECORDS INTO CUST_MASSAGE1*****/
err_table :='UPDATE RECORDS INTO CUST_MASSAGE1';


UPDATE CUST_MASSAGE1 SET SUM_APP_MAPPING =(SELECT DISTINCT B.SUM_APP_MAPPING
 FROM CP_SUM_APP_CODE  B, CUST_MASSAGE1  
WHERE CUST_MASSAGE1.SUM_APP = B.SUM_APP),
NOPROD =(SELECT DISTINCT B.NOPROD
FROM CP_SUM_APP_CODE B, CUST_MASSAGE1
WHERE CUST_MASSAGE1.SUM_APP = B.SUM_APP);



--/***** INSERT RECORDS INTO CUST2A*****/
TRUNCATE TABLE CUST2A;
err_table :='INSERT RECORDS INTO CUST2A';
				 INSERT INTO CUST2A
				 		SELECT NOPROD, SUM_APP_MAPPING, CUS_TYP_CD, FIVE_GROUP, TEN_GROUP, COUNT(CUST_KEY)
							   FROM CUST_MASSAGE1
							   		GROUP BY NOPROD, SUM_APP_MAPPING, CUS_TYP_CD, FIVE_GROUP, TEN_GROUP
										  ORDER BY NOPROD;

--/***** INSERT RECORDS INTO CUST_MASSAGE2*****/

TRUNCATE TABLE CUST_MASSAGE2;
err_table :='INSERT RECORDS INTO CUST_MASSAGE2';
		INSERT INTO CUST_MASSAGE2
			   SELECT A.CUST_KEY, SUM(A.APP_CODE), B.CUS_TYP_CD, SUM(A.SUM_CUR_BAL), SUM(A.CNT_ACCT_NO),B.FIVE_GROUP, B.TEN_GROUP, NULL, NULL,B.CUS_EMP_FLAG
			   		  FROM CUST_ACCTGROUPBY2 A, CUST_AGE B
					  	   WHERE A.CUST_KEY = B.CUST_KEY
						   		 GROUP BY A.CUST_KEY, B.CUS_TYP_CD, B.FIVE_GROUP, B.TEN_GROUP,B.CUS_EMP_FLAG
								 	   ORDER BY A.CUST_KEY;

--/***** UPDATE RECORDS INTO CUST_MASSAGE2*****/
err_table :='INSERT RECORDS INTO CUST_MASSAGE2';

UPDATE CUST_MASSAGE2
SET SUM_APP_MAPPING =(SELECT DISTINCT B.SUM_APP_MAPPING
 FROM CP_SUM_APP_CODE  B, CUST_MASSAGE2  
WHERE CUST_MASSAGE2.SUM_APP = B.SUM_APP),
NOPROD =(SELECT DISTINCT B.NOPROD
FROM CP_SUM_APP_CODE B, CUST_MASSAGE2
WHERE CUST_MASSAGE2.SUM_APP = B.SUM_APP);


--/***** INSERT RECORDS INTO CUST_MASSAGE2*****/

TRUNCATE TABLE CUST2B;
err_table :='INSERT RECORDS INTO CUST_CUST2B';
		INSERT INTO CUST2B
			   SELECT NOPROD, SUM_APP_MAPPING, CUS_TYP_CD, FIVE_GROUP, TEN_GROUP, SUM(SUM_CUR_BAL), SUM(CNT_ACCT_NO)
			   		  FROM CUST_MASSAGE2
					  	   GROUP BY NOPROD, SUM_APP_MAPPING, CUS_TYP_CD, FIVE_GROUP, TEN_GROUP
						   		 ORDER BY NOPROD;

--/***** INSERTING RECORDS TO TABLE CUST_BY_AGE,CUST_BY_GEN,CUST_BY_MARIT,CUST_BY_RACE,CUST_BY_REG *****/

TRUNCATE TABLE CUST_BY_AGE;
TRUNCATE TABLE CUST_BY_GEN;
TRUNCATE TABLE CUST_BY_MARIT;
TRUNCATE TABLE CUST_BY_RACE;
TRUNCATE TABLE CUST_BY_REG;

err_table :='INSERT RECORDS INTO CUST_AGE,GEN,MARIT,RACE,REG';
INSERT INTO CUST_BY_AGE
	   SELECT B.APPL_SYS_ID ,A.TEN_GROUP,
	   		  COUNT (DISTINCT A.CUST_KEY)
			  		FROM CUST_AGE A,CUST_ACCT B
						 WHERE (A.CUST_KEY = B.CUST_KEY)
						 	   GROUP BY (B.APPL_SYS_ID,A.TEN_GROUP);
--COMMIT;							   

INSERT INTO CUST_BY_GEN
	   SELECT B.APPL_SYS_ID,A.SEX_CD,COUNT (DISTINCT A.CUST_KEY)
	   		  FROM CUST_INFO A,CUST_ACCT B
			  	   WHERE (A.CUST_KEY = B.CUST_KEY)
				   		 GROUP BY (B.APPL_SYS_ID,A.SEX_CD);
--COMMIT;						 

INSERT INTO CUST_BY_MARIT
	   SELECT B.APPL_SYS_ID AS PRODUCT,A.MARIT_STAT_CD,COUNT (DISTINCT A.CUST_KEY)
	   		  FROM CUST_INFO A,CUST_ACCT B
			  	   WHERE (A.CUST_KEY = B.CUST_KEY)
				   		 GROUP BY (B.APPL_SYS_ID,A.MARIT_STAT_CD);
--COMMIT;

INSERT INTO CUST_BY_RACE
	   SELECT B.APPL_SYS_ID ,A.ETHNIC_IND_CD,COUNT (DISTINCT A.CUST_KEY)
	   		  FROM CUST_INFO A,CUST_ACCT B
			  	   WHERE (A.CUST_KEY = B.CUST_KEY)
				   		 GROUP BY (B.APPL_SYS_ID,A.ETHNIC_IND_CD);
--COMMIT;

INSERT INTO CUST_BY_REG
	   SELECT B.APPL_SYS_ID ,A.RELIGIOUS_CODE,COUNT (DISTINCT A.CUST_KEY)
	   		  FROM CUST_INFO A,CUST_ACCT B
			  	   WHERE (A.CUST_KEY = B.CUST_KEY)
				   		 GROUP BY (B.APPL_SYS_ID,A.RELIGIOUS_CODE);
--COMMIT;

						 
EXCEPTION
   WHEN OTHERS THEN
      err_num := -1;
      err_msg := SUBSTR('error', 1, 100);
	  err_date := LOCALTIMESTAMP;
      INSERT INTO KPI_ERROR_LOG VALUES (err_num, err_msg,err_table,err_date);
END;

$$
LANGUAGE PLPGSQL;