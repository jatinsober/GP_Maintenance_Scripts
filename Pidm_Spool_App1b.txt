------
--DEV BY : Jitendra Lodwal  
--DATE  : 06-SEP-2011 
--DESC : FUNCTION
------

SET SEARCH_PATH TO WORKAREA;

CREATE OR REPLACE FUNCTION Pidm_Spool_App1b (inout P_DATE DATE) RETURNS DATE AS $body$

DECLARE

cnt NUMERIC;

FILE1 TEXT;
FILE2 TEXT;
FILE3 TEXT;
FILE4 TEXT;

roc_val VARCHAR (20);
bor_val VARCHAR (150);
TRAN_DATE DATE;
SYSTEMDT VARCHAR(8);
buffer VARCHAR (1000);

BEGIN

TRUNCATE TABLE PIDM_APP1B;
TRUNCATE TABLE PIDM_AMBK_HDA_APP1B;
TRUNCATE TABLE PIDM_AMBK_NONHDA_APP1B;
TRUNCATE TABLE PIDM_AMIS_HDA_APP1B;
TRUNCATE TABLE PIDM_AMIS_NONHDA_APP1B;

BEGIN

INSERT INTO PIDM_APP1B
SELECT  
A.ACCT_ACCT_NO  AS ACCT_NO,
CASE WHEN CONTROL4 IN ('001','003','007','201','008') THEN 2 
WHEN CONTROL4 IN ('002','004','013','202','009') THEN 1 END AS BANK_TYP,
ACCT_GL_GROUP_CODE   AS ACCT_GL_GROUP_CD,
CUST_NM_LINE        AS ACCTNAME,
CAR_C_CIF_NO        AS ACCTHOLDERCIFNO,
CUST_NM_LINE        AS HOLDERSNAME,
CUST_SALUTATION  AS HLDRS_SALUTATION,
CASE WHEN  CUST_ID_TYPE = '6' THEN CAR_PRIMARY_ID END AS NEWICNO,
CASE WHEN  CUST_ID_TYPE = '0' THEN CAR_PRIMARY_ID END AS OLDICNO,  
CASE WHEN  CUST_ID_TYPE IN ( '7','8')  THEN CAR_PRIMARY_ID  END  AS POLIC_ARMY_ICNO, 
CASE WHEN  CUST_CITIZEN IN ('1','2') AND  CUST_ID_TYPE = '3'  THEN  CAR_PRIMARY_ID END AS PASSPORTNO,
CASE WHEN  CUST_CITIZEN IN ('1','2') THEN 'NON-RESIDENT' WHEN CUST_CITIZEN IN ('0','3') THEN 'RESIDENT' END AS RES_NONRES,
CASE WHEN  CUST_TYP_CD = 'P' THEN TO_CHAR(PER_CUST_DOB,'YYYYMMDD') WHEN CUST_TYP_CD = 'O' THEN TO_CHAR(NP_CUST_DOI,'YYYYMMDD')   END AS DATEOFBIRTH,
CASE WHEN PER_SEX_CD ='L' THEN '1' 
WHEN PER_SEX_CD ='P' THEN '2' ELSE '3' END AS SEX ,
CASE WHEN PER_ETHNIC_IND_CD=1 THEN 1 
WHEN PER_ETHNIC_IND_CD IN ('4','5','6') THEN 2 
WHEN PER_ETHNIC_IND_CD =2 THEN 3 
WHEN PER_ETHNIC_IND_CD =3 THEN 4
WHEN PER_ETHNIC_IND_CD IN ('0','9') THEN 5 END AS RACE, 
CAR_CUST_KEY 
FROM PIDM_ACCT A, PIDM_CAR C 
LEFT OUTER JOIN PIDM_CUST B ON C.CAR_CUST_KEY = B.CUST_KEY
LEFT OUTER JOIN PIDM_CUST_PERS D ON B.CUST_KEY  =  D.PER_CUST_KEY
LEFT OUTER JOIN PIDM_NON_PERS E ON C.CAR_CUST_KEY  =  E.NP_CUST_KEY 
WHERE  A.ACCT_ACCT_ID = C.CAR_R_ACCT_ID AND
CAR_PRIME_NO_NEW ='Y' --onli take primary holder
AND    (C.CAR_EXPIRATION_DT >= P_DATE OR C.CAR_EXPIRATION_DT = TO_DATE('01/01/0001','MM/DD/YYYY'));




INSERT INTO PIDM_APP1B
SELECT  
A.ACCT_ACCT_NO  AS ACCT_NO,
CASE WHEN CONTROL4 IN ('001','003','007','201','008') THEN 2 
WHEN CONTROL4 IN ('002','004','013','202','009') THEN 1 END AS BANK_TYP,
ACCT_GL_GROUP_CODE   AS ACCT_GL_GROUP_CD,
CUST_NM_LINE        AS ACCTNAME,
CAR_C_CIF_NO        AS ACCTHOLDERCIFNO,
CUST_NM_LINE        AS HOLDERSNAME,
CUST_SALUTATION  AS HLDRS_SALUTATION,
CASE WHEN  CUST_ID_TYPE = '6' THEN CAR_PRIMARY_ID END AS NEWICNO,
CASE WHEN  CUST_ID_TYPE = '0' THEN CAR_PRIMARY_ID END AS OLDICNO,  
CASE WHEN  CUST_ID_TYPE IN ( '7','8')  THEN CAR_PRIMARY_ID  END  AS POLIC_ARMY_ICNO, 
CASE WHEN  CUST_CITIZEN IN ('1','2') AND  CUST_ID_TYPE = '3'  THEN  CAR_PRIMARY_ID END AS PASSPORTNO,
CASE WHEN  CUST_CITIZEN IN ('1','2') THEN 'NON-RESIDENT' WHEN CUST_CITIZEN IN ('0','3') THEN 'RESIDENT' END AS RES_NONRES,
CASE WHEN  CUST_TYP_CD = 'P' THEN TO_CHAR(PER_CUST_DOB,'YYYYMMDD') WHEN CUST_TYP_CD = 'O' THEN TO_CHAR(NP_CUST_DOI,'YYYYMMDD')   END AS DATEOFBIRTH,
CASE WHEN PER_SEX_CD ='L' THEN '1' 
WHEN PER_SEX_CD ='P' THEN '2' ELSE '3' END AS SEX ,
CASE WHEN PER_ETHNIC_IND_CD=1 THEN 1 
WHEN PER_ETHNIC_IND_CD IN ('4','5','6') THEN 2 
WHEN PER_ETHNIC_IND_CD =2 THEN 3 
WHEN PER_ETHNIC_IND_CD =3 THEN 4
WHEN PER_ETHNIC_IND_CD IN ('0','9') THEN 5 END AS RACE, 
CAR_CUST_KEY 
FROM PIDM_ACCT A ,PIDM_CAR C
LEFT OUTER JOIN PIDM_CUST B ON C.CAR_CUST_KEY = B.CUST_KEY
LEFT OUTER JOIN PIDM_CUST_PERS D ON B.CUST_KEY  =  D.PER_CUST_KEY 
LEFT OUTER JOIN PIDM_NON_PERS E ON C.CAR_CUST_KEY  =  E.NP_CUST_KEY
WHERE  A.ACCT_ACCT_ID = C.CAR_R_ACCT_ID
AND    CAR_PRIME_NO_NEW IS NULL 
AND    ACCT_SUB_TYP_IND IN ('102','706','710','103','104','502','707','708','711','712','715','718','714','719')
AND    (C.CAR_EXPIRATION_DT >= P_DATE OR C.CAR_EXPIRATION_DT = TO_DATE('01/01/0001','MM/DD/YYYY'));


UPDATE PIDM_APP1B SET DOB = '19000101' 
WHERE DOB = '00010101' OR DOB IS NULL; 
--COMMIT ;  


CREATE TEMP TABLE MCD_OUTPUT_F1 (
R_ORDER NUMERIC,COL_1 VARCHAR,ACCT_NO VARCHAR,CUST_NM_LINE VARCHAR,CAR_C_CIF_NO  VARCHAR,HOLDER_NAME  VARCHAR,CUST_SALUTATION VARCHAR, NEW_ICNO  VARCHAR,OLD_ICNO VARCHAR,POLICE_ARMY_ICNO VARCHAR,PASSPORTNO VARCHAR,RES_NONRES_ID VARCHAR,DOB VARCHAR,PER_SEX_CD VARCHAR,PER_ETHNIC_IND_CD VARCHAR
,COL_2 NUMERIC
) ;

FILE1 := $$/home/gpadmin/PIDM_DIR/PIDM_AMBANK_HDA_APP1B$$ ||'.txt';
	

SYSTEMDT := TO_CHAR(CURRENT_DATE,'YYYYMMDD') ;

INSERT INTO MCD_OUTPUT_F1 (R_ORDER,COL_1) VALUES (1,'0208052009123101001');

INSERT INTO PIDM_AMBK_HDA_APP1B
 SELECT   ACCT_ACCT_NO, CUST_NM_LINE,CAR_C_CIF_NO ,HOLDER_NAME,CUST_SALUTATION,NEW_ICNO, OLD_ICNO, POLICE_ARMY_ICNO, PASSPORTNO,RES_NONRES_ID,
DOB, PER_SEX_CD, PER_ETHNIC_IND_CD  FROM PIDM_APP1B
WHERE  BANK_TYP = '2' AND ACCT_GL_GROUP_CODE = '011'; -- Ambank HDA


INSERT INTO MCD_OUTPUT_F1(R_ORDER,ACCT_NO ,CUST_NM_LINE ,CAR_C_CIF_NO  ,HOLDER_NAME  ,CUST_SALUTATION , NEW_ICNO  ,OLD_ICNO ,POLICE_ARMY_ICNO ,PASSPORTNO ,RES_NONRES_ID ,DOB ,PER_SEX_CD ,PER_ETHNIC_IND_CD )
VALUES (2,'ACCT_NO','CUST_NM_LINE','CAR_C_CIF_NO','HOLDER_NAME','CUST_SALUTATION','NEW_ICNO','OLD_ICNO','POLICE_ARMY_ICNO','PASSPORTNO','RES_NONRES','DOB','GENDER','RACE');


INSERT INTO MCD_OUTPUT_F1 (R_ORDER, ACCT_NO,CUST_NM_LINE,CAR_C_CIF_NO ,HOLDER_NAME ,CUST_SALUTATION, NEW_ICNO ,OLD_ICNO,POLICE_ARMY_ICNO,PASSPORTNO,RES_NONRES_ID,DOB,PER_SEX_CD,PER_ETHNIC_IND_CD) SELECT 2, ACCT_NO,CUST_NM_LINE,CAR_C_CIF_NO ,HOLDER_NAME ,CUST_SALUTATION, NEW_ICNO ,OLD_ICNO,POLICE_ARMY_ICNO,PASSPORTNO,RES_NONRES_ID,DOB,PER_SEX_CD,PER_ETHNIC_IND_CD FROM PIDM_AMBK_HDA_APP1B ;

SELECT COUNT(*) INTO cnt  FROM PIDM_AMBK_HDA_APP1B;
INSERT INTO MCD_OUTPUT_F1 (R_ORDER,COL_2) VALUES (3,cnt);

EXECUTE 'copy (select COL_1,ACCT_NO,CUST_NM_LINE,CAR_C_CIF_NO ,HOLDER_NAME ,CUST_SALUTATION, NEW_ICNO ,OLD_ICNO,POLICE_ARMY_ICNO,PASSPORTNO,RES_NONRES_ID,DOB,PER_SEX_CD,PER_ETHNIC_IND_CD,COL_2 from MCD_OUTPUT_F1 order by R_ORDER) to  ''' || FILE1 || ''';';


END;
--FILE2
BEGIN


FILE2 := $$/home/gpadmin/PIDM_DIR/PIDM_AMBANK_NONHDA_APP1B$$ ||'.txt';
	

SYSTEMDT := TO_CHAR(CURRENT_DATE,'YYYYMMDD') ;

CREATE TEMP TABLE MCD_OUTPUT_F2 (
R_ORDER NUMERIC,COL_1 VARCHAR,ACCT_NO VARCHAR,CUST_NM_LINE VARCHAR,CAR_C_CIF_NO  VARCHAR,HOLDER_NAME  VARCHAR,CUST_SALUTATION VARCHAR, NEW_ICNO  VARCHAR,OLD_ICNO VARCHAR,POLICE_ARMY_ICNO VARCHAR,PASSPORTNO VARCHAR,RES_NONRES_ID VARCHAR,DOB VARCHAR,PER_SEX_CD VARCHAR,PER_ETHNIC_IND_CD VARCHAR
,COL_2 NUMERIC
) ;
INSERT INTO MCD_OUTPUT_F2 (R_ORDER,COL_1) VALUES (1,'0208022009123101001');


INSERT INTO PIDM_AMBK_NONHDA_APP1B 
SELECT    ACCT_ACCT_NO, CUST_NM_LINE,CAR_C_CIF_NO ,HOLDER_NAME,CUST_SALUTATION,NEW_ICNO, OLD_ICNO, POLICE_ARMY_ICNO, PASSPORTNO,RES_NONRES_ID,
DOB, PER_SEX_CD, PER_ETHNIC_IND_CD  FROM PIDM_APP1B
WHERE  BANK_TYP = '2' AND (ACCT_GL_GROUP_CODE <> '011' OR ACCT_GL_GROUP_CODE IS NULL); --Ambank NON HDA

INSERT INTO MCD_OUTPUT_F2(R_ORDER,ACCT_NO ,CUST_NM_LINE ,CAR_C_CIF_NO  ,HOLDER_NAME  ,CUST_SALUTATION , NEW_ICNO  ,OLD_ICNO ,POLICE_ARMY_ICNO ,PASSPORTNO ,RES_NONRES_ID ,DOB ,PER_SEX_CD ,PER_ETHNIC_IND_CD) VALUES(2,'ACCT_NO','CUST_NM_LINE','CAR_C_CIF_NO','HOLDER_NAME','CUST_SALUTATION','NEW_ICNO','OLD_ICNO','POLICE_ARMY_ICNO','PASSPORTNO','RES_NONRES','DOB','GENDER','RACE');

INSERT INTO MCD_OUTPUT_F2 (R_ORDER, ACCT_NO,CUST_NM_LINE,CAR_C_CIF_NO ,HOLDER_NAME ,CUST_SALUTATION, NEW_ICNO ,OLD_ICNO,POLICE_ARMY_ICNO,PASSPORTNO,RES_NONRES_ID,DOB,PER_SEX_CD,PER_ETHNIC_IND_CD) SELECT 2, ACCT_NO,CUST_NM_LINE,CAR_C_CIF_NO ,HOLDER_NAME ,CUST_SALUTATION, NEW_ICNO ,OLD_ICNO,POLICE_ARMY_ICNO,PASSPORTNO,RES_NONRES_ID,DOB,PER_SEX_CD,PER_ETHNIC_IND_CD FROM PIDM_AMBK_NONHDA_APP1B ;

SELECT COUNT(*) INTO cnt  FROM PIDM_AMBK_NONHDA_APP1B;
INSERT INTO MCD_OUTPUT_F2 (R_ORDER,COL_2) VALUES (3,cnt);

EXECUTE 'copy (select COL_1,ACCT_NO,CUST_NM_LINE,CAR_C_CIF_NO ,HOLDER_NAME ,CUST_SALUTATION, NEW_ICNO ,OLD_ICNO,POLICE_ARMY_ICNO,PASSPORTNO,RES_NONRES_ID,DOB,PER_SEX_CD,PER_ETHNIC_IND_CD,COL_2 from MCD_OUTPUT_F2 order by R_ORDER) to  ''' || FILE2 || ''';';

END;


--FILE3

BEGIN

FILE3 := $$/home/gpadmin/PIDM_DIR/PIDM_AMISLAMIC_HDA_APP1B$$ ||'.txt';
	

SYSTEMDT := TO_CHAR(CURRENT_DATE,'YYYYMMDD') ;

CREATE TEMP TABLE MCD_OUTPUT_F3 (
R_ORDER NUMERIC,COL_1 VARCHAR,ACCT_NO VARCHAR,CUST_NM_LINE VARCHAR,CAR_C_CIF_NO  VARCHAR,HOLDER_NAME  VARCHAR,CUST_SALUTATION VARCHAR, NEW_ICNO  VARCHAR,OLD_ICNO VARCHAR,POLICE_ARMY_ICNO VARCHAR,PASSPORTNO VARCHAR,RES_NONRES_ID VARCHAR,DOB VARCHAR,PER_SEX_CD VARCHAR,PER_ETHNIC_IND_CD VARCHAR
,COL_2 NUMERIC
) ;

INSERT INTO MCD_OUTPUT_F3 (R_ORDER,COL_1) VALUES (1,'0349022009123101001');

INSERT INTO PIDM_AMIS_HDA_APP1B 
SELECT    ACCT_ACCT_NO, CUST_NM_LINE,CAR_C_CIF_NO ,HOLDER_NAME,CUST_SALUTATION,NEW_ICNO, OLD_ICNO, POLICE_ARMY_ICNO, PASSPORTNO,RES_NONRES_ID,
DOB, PER_SEX_CD, PER_ETHNIC_IND_CD  FROM PIDM_APP1B
WHERE  BANK_TYP = '1' AND ACCT_GL_GROUP_CODE = '011';   --AmIslamic HDA

INSERT INTO MCD_OUTPUT_F3(R_ORDER,ACCT_NO ,CUST_NM_LINE ,CAR_C_CIF_NO  ,HOLDER_NAME  ,CUST_SALUTATION , NEW_ICNO  ,OLD_ICNO ,POLICE_ARMY_ICNO ,PASSPORTNO ,RES_NONRES_ID ,DOB ,PER_SEX_CD ,PER_ETHNIC_IND_CD)
VALUES (2,'ACCT_NO','CUST_NM_LINE','CAR_C_CIF_NO','HOLDER_NAME','CUST_SALUTATION','NEW_ICNO','OLD_ICNO','POLICE_ARMY_ICNO','PASSPORTNO','RES_NONRES','DOB','GENDER','RACE');

INSERT INTO MCD_OUTPUT_F3 (R_ORDER, ACCT_NO,CUST_NM_LINE,CAR_C_CIF_NO ,HOLDER_NAME ,CUST_SALUTATION, NEW_ICNO ,OLD_ICNO,POLICE_ARMY_ICNO,PASSPORTNO,RES_NONRES_ID,DOB,PER_SEX_CD,PER_ETHNIC_IND_CD) SELECT 2, ACCT_NO,CUST_NM_LINE,CAR_C_CIF_NO ,HOLDER_NAME ,CUST_SALUTATION, NEW_ICNO ,OLD_ICNO,POLICE_ARMY_ICNO,PASSPORTNO,RES_NONRES_ID,DOB,PER_SEX_CD,PER_ETHNIC_IND_CD FROM PIDM_AMIS_HDA_APP1B ;

SELECT COUNT(*) INTO cnt  FROM PIDM_AMIS_HDA_APP1B;
INSERT INTO MCD_OUTPUT_F3 (R_ORDER,COL_2) VALUES (3,cnt);

EXECUTE 'copy (select COL_1,ACCT_NO,CUST_NM_LINE,CAR_C_CIF_NO ,HOLDER_NAME ,CUST_SALUTATION, NEW_ICNO ,OLD_ICNO,POLICE_ARMY_ICNO,PASSPORTNO,RES_NONRES_ID,DOB,PER_SEX_CD,PER_ETHNIC_IND_CD,COL_2 from MCD_OUTPUT_F3 order by R_ORDER) to  ''' || FILE3 || ''';';

END;

--FILE4

BEGIN


FILE4 := $$/home/gpadmin/PIDM_DIR/PIDM_AMISLAMIC_NONHDA_APP1B$$ ||'.txt';
	

SYSTEMDT := TO_CHAR(CURRENT_DATE,'YYYYMMDD') ;

CREATE TEMP TABLE MCD_OUTPUT_F4 (
R_ORDER NUMERIC,COL_1 VARCHAR,ACCT_NO VARCHAR,CUST_NM_LINE VARCHAR,CAR_C_CIF_NO  VARCHAR,HOLDER_NAME  VARCHAR,CUST_SALUTATION VARCHAR, NEW_ICNO  VARCHAR,OLD_ICNO VARCHAR,POLICE_ARMY_ICNO VARCHAR,PASSPORTNO VARCHAR,RES_NONRES_ID VARCHAR,DOB VARCHAR,PER_SEX_CD VARCHAR,PER_ETHNIC_IND_CD VARCHAR
,COL_2 NUMERIC
) ;
INSERT INTO MCD_OUTPUT_F4 (R_ORDER,COL_1) VALUES (1,'0349022009123101001');


INSERT INTO PIDM_AMIS_NONHDA_APP1B
SELECT   ACCT_ACCT_NO, CUST_NM_LINE,CAR_C_CIF_NO ,HOLDER_NAME,CUST_SALUTATION,NEW_ICNO, OLD_ICNO, POLICE_ARMY_ICNO, PASSPORTNO,RES_NONRES_ID,
DOB, PER_SEX_CD, PER_ETHNIC_IND_CD  FROM PIDM_APP1B
WHERE  BANK_TYP = '1' AND (ACCT_GL_GROUP_CODE <> '011' OR ACCT_GL_GROUP_CODE IS NULL);   --AmIslamic NONHDA

INSERT INTO MCD_OUTPUT_F4(R_ORDER,ACCT_NO ,CUST_NM_LINE ,CAR_C_CIF_NO  ,HOLDER_NAME  ,CUST_SALUTATION , NEW_ICNO  ,OLD_ICNO ,POLICE_ARMY_ICNO ,PASSPORTNO ,RES_NONRES_ID ,DOB ,PER_SEX_CD ,PER_ETHNIC_IND_CD)
VALUES (2,'ACCT_NO','CUST_NM_LINE','CAR_C_CIF_NO','HOLDER_NAME','CUST_SALUTATION','NEW_ICNO','OLD_ICNO','POLICE_ARMY_ICNO','PASSPORTNO','RES_NONRES','DOB','GENDER','RACE');

INSERT INTO MCD_OUTPUT_F4 (R_ORDER, ACCT_NO,CUST_NM_LINE,CAR_C_CIF_NO ,HOLDER_NAME ,CUST_SALUTATION, NEW_ICNO ,OLD_ICNO,POLICE_ARMY_ICNO,PASSPORTNO,RES_NONRES_ID,DOB,PER_SEX_CD,PER_ETHNIC_IND_CD) SELECT 2, ACCT_NO,CUST_NM_LINE,CAR_C_CIF_NO ,HOLDER_NAME ,CUST_SALUTATION, NEW_ICNO ,OLD_ICNO,POLICE_ARMY_ICNO,PASSPORTNO,RES_NONRES_ID,DOB,PER_SEX_CD,PER_ETHNIC_IND_CD FROM PIDM_AMIS_NONHDA_APP1B ;

SELECT COUNT(*) INTO cnt  FROM PIDM_AMIS_NONHDA_APP1B;

INSERT INTO MCD_OUTPUT_F4 (R_ORDER,COL_2) VALUES (3,cnt);

EXECUTE 'copy (select COL_1,ACCT_NO,CUST_NM_LINE,CAR_C_CIF_NO ,HOLDER_NAME ,CUST_SALUTATION, NEW_ICNO ,OLD_ICNO,POLICE_ARMY_ICNO,PASSPORTNO,RES_NONRES_ID,DOB,PER_SEX_CD,PER_ETHNIC_IND_CD,COL_2 from MCD_OUTPUT_F4 order by R_ORDER) to  ''' || FILE4 || ''';';


return;
END;
END;

$body$  
LANGUAGE plpgsql VOLATILE; 

