------
--DEV BY : Jitendra Lodwal  
--DATE  : 06-SEP-2011 
--DESC : FUNCTION
------

SET SEARCH_PATH TO WORKAREA;

CREATE OR REPLACE FUNCTION Pidm_Spool_App1d () RETURNS VOID AS $body$
DECLARE

cnt NUMERIC;
FILE1 TEXT;
FILE2 TEXT;
FILE3 TEXT;
roc_val VARCHAR (20);
bor_val VARCHAR (150);
TRAN_DATE DATE;
SYSTEMDT VARCHAR(8);
buffer VARCHAR (1000);

BEGIN

TRUNCATE TABLE PIDM_AMIS_NONHDA_APP1D;

BEGIN

INSERT INTO PIDM_APP1D
SELECT 
CAR_A_ACCT_NO AS ACCT_NO,
CASE WHEN  ACCT_APPL_SYS_ID = 'STS' AND CONTROL4 IN ('001','003','007','201','008') THEN 2 
WHEN  ACCT_APPL_SYS_ID = 'IMS' AND CONTROL4 IN ('002','004','013','202','009') THEN 1 END AS BANK_TYP,
ACCT_GL_GROUP_CODE AS ACCT_GL_GROUP_CD,
'MYR' AS CURRENCY,
CUST_NM_LINE AS CUSTOMERNAME,
'NA' AS BENEFICIARYNAME,
'NA' AS BENEFICIARYNO,
'NA' AS BENEFICIARYADDR,
'0'  AS BENEFICIARY_INTRST,
CAR_REL_TYP_CD  AS CAR_REL_TYP_CD
FROM PIDM_CAR A, PIDM_CUST B , PIDM_ACCT C
WHERE   A.CAR_CUST_KEY = B.CUST_KEY
AND     A.CAR_R_ACCT_ID = C.ACCT_ACCT_ID  
AND     A.CAR_PRIME_NO_NEW ='Y' --only PRIMARY holder
AND    (A.CAR_EXPIRATION_DT >= '31-DEC-2009' OR A.CAR_EXPIRATION_DT = TO_DATE('01/01/0001','MM/DD/YYYY'));
--AND    A.CAR_REL_TYP_CD = '58'
--AND    C.ACCT_GL_GROUP_CODE = '011'


CREATE TEMP TABLE MCD_OUTPUT_F1  (
R_ORDER VARCHAR,COL_1 VARCHAR,COL_2 VARCHAR,COL_3 VARCHAR,COL_4 VARCHAR,ACCT_NO VARCHAR);

FILE1 := $$/home/gpadmin/PIDM_DIR/PIDM_AMBANK_NONHDA_App1D_0$$ ||'.txt';
FILE2 := $$/home/gpadmin/PIDM_DIR/PIDM_AMBANK_NONHDA_App1D_1$$ ||'.txt';
FILE3 := $$/home/gpadmin/PIDM_DIR/PIDM_AMBANK_NONHDA_App1D_2$$ ||'.txt';
	

SYSTEMDT := TO_CHAR(CURRENT_DATE,'YYYYMMDD') ;

INSERT INTO MCD_OUTPUT_F1 (R_ORDER,COL_1,COL_2,COL_3,COL_4) VALUES ( 1,'Transaction Header App1D','  ','FISS02',SYSTEMDT );

INSERT INTO PIDM_AMIS_NONHDA_APP1D
SELECT ACCT_NO, CURRENCY, CUST_NM_LINE, BENEF_NAME, BENEF_NO, BENEF_ADDR,BENEF_INST
FROM PIDM_APP1D A
WHERE  BANK_TYP = '1' AND ACCT_GL_GROUP_CD <> '011';


EXECUTE 'copy (select * from MCD_OUTPUT_F1 order by R_ORDER) to  ''' || FILE1 || ''';';


CREATE TEMP TABLE MCD_OUTPUT_F2
(R_ORDER VARCHAR,
ACCT_NO VARCHAR,
CURRENCY VARCHAR,CUSTOMER_NAME VARCHAR,BENEFICIARY_NAME VARCHAR,BENEFICIARY_ID VARCHAR,BENEFICIARY_ADDR VARCHAR,BENEFICIARY_INSTREST VARCHAR);			

INSERT INTO MCD_OUTPUT_F2 (R_ORDER,ACCT_NO,CURRENCY,CUSTOMER_NAME,BENEFICIARY_NAME,BENEFICIARY_ID,BENEFICIARY_ADDR,BENEFICIARY_INSTREST) VALUES ('R_ORDER','ACCT_NO','CURRENCY','CUSTOMER_NAME','BENEFICIARY_NAME','BENEFICIARY_ID','BENEFICIARY_ADDR','BENEFICIARY_INSTREST');

INSERT INTO MCD_OUTPUT_F2 (R_ORDER,ACCT_NO,CURRENCY,CUSTOMER_NAME,BENEFICIARY_NAME,BENEFICIARY_ID,BENEFICIARY_ADDR,BENEFICIARY_INSTREST) SELECT 2,ACCT_NO,CURRENCY,CUST_NM_LINE,BENEF_NAME,BENEF_ID,BENEF_ADDR,BENEF_INST FROM PIDM_AMIS_NONHDA_APP1D ;

EXECUTE 'copy (select * from MCD_OUTPUT_F2 order by R_ORDER) to  ''' || FILE2 || ''';';

CREATE TEMP TABLE MCD_OUTPUT_F3 (COL_5 VARCHAR) ;
cnt := COUNT(*)
FROM PIDM_AMIS_NONHDA_APP1D;

INSERT INTO MCD_OUTPUT_F3 (COL_5) VALUES ('Transaction Footer Count= '||cnt);

EXECUTE 'copy (select * from MCD_OUTPUT_F3) to  ''' || FILE3 || ''';';


END;
END;

$body$  
LANGUAGE plpgsql VOLATILE; 

