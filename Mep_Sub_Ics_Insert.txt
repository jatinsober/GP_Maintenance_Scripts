------
--DEV BY : Jitendra Lodwal  
--DATE  : 25-AUG-2011 
--DESC : FUNCTION
------

SET SEARCH_PATH TO WORKAREA;

CREATE OR REPLACE FUNCTION Mep_Sub_Ics_Insert() RETURNS VOID AS $$

 BEGIN
--ICS
--deli

TRUNCATE TABLE MEP_DELI_ICS ;
INSERT INTO MEP_DELI_ICS
(MDL_ACCT_NO, MDL_APPL_SYS_ID, MDL_CYC_DT, MDL_MIA, MDL_MIA_AMT, MDL_LOG_DT, MDL_PYMT,
 MDL_RENEGOTIATE,MDL_SEC_STATUS_CD,MDL_INS_DISPOS_DT,MDL_COLL_NEW,MDL_BNM_MAKE,MDL_WATCHLIST_TAG,
 MDL_IFRS_TAG,MDL_CASH_PRICE)
SELECT A.ACCT_ACCT_NO MDL_ACCT_NO, A.ACCT_APPL_SYS_ID MDL_APPL_SYS_ID,
A.ACCT_BUS_CYC_DT MDL_CYC_DT, B.IIS_MOS_IN_ARREARS MDL_MIA,
CASE WHEN B.IIS_WRITE_OFF_STAT='X' THEN A.ACCT_CUR_BAL ELSE C.CI_AMT_PAST_DUE END AS MDL_MIA_AMT, LOCALTIMESTAMP MDL_LOG_DT,
C.CI_MTD_PYMT_AMT MDL_PYMT,
C.CI_RENEGOTIATE,C.CI_SEC_STATUS_CD,C.CI_INS_DISPOS_DT,C.CI_COLL_NEW,C.CI_BNM_MAKE,C.CI_WATCHLIST_TAG,C.CI_IFRS_TAG,C.CI_CASH_PRICE
FROM  dwprod.acct_ht_1_prt_acct_ht_201009 A ,dwprod.credit_provisions_ht_1_prt_credit_provisions_ht_201009 B ,
dwprod.consumer_inst_ln_ht_1_prt_consumer_inst_ln_ht_201009 C
WHERE  A.ACCT_ACCT_NO = B.IIS_ACCT_NO
AND A.ACCT_ACCT_NO=C.CI_ACCT_NO
AND A.ACCT_APPL_SYS_ID = 'ICS';
--COMMIT;
--overlimit

TRUNCATE TABLE MEP_OVLIMIT_ICS ;
INSERT INTO MEP_OVLIMIT_ICS(MO_ACCT_NO,MO_APPL_SYS_ID,MO_CYC_DT,MO_OVLIMIT_IND,MO_LOG_DT,MO_OS_AMT )
SELECT ACCT_ACCT_NO  MO_ACCT_NO, ACCT_APPL_SYS_ID MO_APPL_SYS_ID,
ACCT_BUS_CYC_DT MO_CYC_DT, CASE WHEN ACCT_CUR_BAL > ACCT_LIMIT_AMT
THEN 'Y' ELSE 'N' END AS MO_OVLIMIT_IND,LOCALTIMESTAMP  MO_LOG_DT ,
ACCT_CUR_BAL MO_OS_AMT
FROM dwprod.acct_ht_1_prt_acct_ht_201009
WHERE ACCT_APPL_SYS_ID = 'ICS';
--COMMIT;


TRUNCATE TABLE MEP_STATUS_ICS;
INSERT INTO MEP_STATUS_ICS (MS_ACCT_NO,MS_APPL_SYS_ID,MS_CYC_DT,MS_STAT_CD,
MS_WOFF_IND,MS_NPL_STAT)
SELECT  A.ACCT_ACCT_NO MS_ACCT_NO, A.ACCT_APPL_SYS_ID MS_APPL_SYS_ID,
A.ACCT_BUS_CYC_DT MS_CYC_DT,
CASE WHEN IIS_WRITE_OFF_STAT ='X' THEN IIS_WRITE_OFF_STAT ELSE  A.ACCT_STAT_CD END AS MS_STAT_CD,
CASE WHEN C.IIS_WRITE_OFF_STAT ='X'THEN 'Y' ELSE 'N' END,
A.ACCT_NPL_STAT
FROM  dwprod.acct_ht_1_prt_acct_ht_201009 A, dwprod.credit_provisions_ht_1_prt_credit_provisions_ht_201009 C
WHERE A.ACCT_APPL_SYS_ID = 'ICS'
AND A.ACCT_ACCT_NO=C.IIS_ACCT_NO;

--COMMIT;
END;

$$
LANGUAGE PLPGSQL;
