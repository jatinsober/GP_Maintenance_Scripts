------
--DEV BY : Jitendra Lodwal  
--DATE  : 25-AUG-2011 
--DESC : FUNCTION
------

SET SEARCH_PATH TO WORKAREA;

CREATE OR REPLACE FUNCTION Mep_Sub_Cps_Insert() RETURNS VOID AS $$

--CPS
--overlimit
BEGIN

TRUNCATE TABLE MEP_OVLIMIT_CPS;
INSERT INTO MEP_OVLIMIT_CPS(MO_ACCT_NO,MO_APPL_SYS_ID,MO_CYC_DT,MO_OVLIMIT_IND,MO_LOG_DT,MO_CRDT_LMT,MO_OS_AMT)SELECT B.VM_ACCT_NO  AS MO_ACCT_NO,B.VM_APPL_SYS_ID AS MO_APPL_SYS_ID,B.VM_BUS_CYC_DT AS MO_CYC_DT,CASE B.VM_OL_FLAGWHEN '1'THEN 'Y'ELSE 'N'END AS MO_OVLIMIT_IND,LOCALTIMESTAMP  AS MO_LOG_DT,  B.VM_CRLIMIT_PERM AS MO_CRDT_LMT ,ACCT_CUR_BALFROM DWPROD.ACCT_HT_1_PRT_ACCT_HT_201104 A, DWPROD.CARD_CREDIT_LINE_HT_1_PRT_CARD_CREDIT_LINE_HT_201104 BWHERE B.VM_APPL_SYS_ID = 'CPS'AND  A.ACCT_ACCT_NO  = B.VM_ACCT_NO;
--COMMIT;

--status
TRUNCATE TABLE MEP_STATUS_CPS;
INSERT INTO MEP_STATUS_CPS(MS_ACCT_NO, MS_APPL_SYS_ID, MS_CYC_DT, MS_STAT_CD,MS_LOG_DT,MS_STAT_RANK)
SELECT  A.ACCT_ACCT_NO MS_ACCT_NO, A.ACCT_APPL_SYS_ID MS_APPL_SYS_ID,
A.ACCT_BUS_CYC_DT MS_CYC_DT,A.ACCT_STAT_CD  MS_STAT_CD,LOCALTIMESTAMP  MS_LOG_DT ,MSR_STAT_RANK
FROM dwprod.acct_ht_1_prt_acct_ht_201104 A ,MEP_STAT_RANK B
WHERE ACCT_STAT_CD = MSR_STAT_CD
AND A.ACCT_APPL_SYS_ID = 'CPS';
--COMMIT;

UPDATE MEP_STATUS_CPS
SET MS_STAT_RANK = '3'
WHERE MS_STAT_CD IS NULL;
--COMMIT;
END;
$$
LANGUAGE PLPGSQL;

