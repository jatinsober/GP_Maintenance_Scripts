------
--DEV BY : Jitendra Lodwal  
--DATE  : 26-AUG-2011 
--DESC : FUNCTION
------

SET SEARCH_PATH TO WORKAREA;
CREATE OR REPLACE FUNCTION BSCORE_XTRACT_ALS_ACCT_UAT_ORI(CYC_DT2 IN DATE) RETURNS VOID AS $$
BEGIN

	 TRUNCATE TABLE BSCORE_ALS_ACCT_UAT;
	 
	 INSERT INTO BSCORE_PROC_LOG(SYS_ID, BUS_CYC_DT, PROCESS_MSG, PROC_DT)
	 VALUES ('ALS', CYC_DT2, 'START INSERT BSCORE_ALS_ACCT', LOCALTIMESTAMP);
	 

	 INSERT INTO BSCORE_ALS_ACCT_UAT(BUS_CYC_DT, ACCT_NO, ACCT_STAT, BANKRUPT_FLG,
	 BANKRUPT_VAL, CHARGE_OFF_DT, CHARGE_OFF_FLG, CYC_BAL_VAL_WITH_EPP, CYC_DT, CLOSED_DT,
	 LST_WOFF_DT, LST_PYMT_DT, DEFAULT_AMT, DEFAULT_FLG, INT_RATE, LEGAL_DT, LEGAL_FLG,
	 LEGAL_STAT, LEGAL_VAL, ONSELLING_PYMT_AMT, PROD_CD, RESTRU_FLG, RESTRU_VAL, WOFF_VAL,
	 ACCT_STAT_2, ACCT_STAT_3, BUS_ACT, CONST_CD, FINAL_PYMT_DT, FAC_CD, INSTALL_AMT,
	 MAT_DT, CYC_PRIN_BALOS, APPLICANT_CNT, GUARANTOR_CNT, PURPOSE_CD, REPYMT_PERIOD,
	 RESCHE_FLG, SETTLE_DT, CR_LMT, DELINQ_BUCKET, OPEN_DT, AKPK, SPEC_PROVISION, TERM,
	 REPYMT_INT, REPYMT_FEE, REPYMT_LPI, SME_TAG, IIS_LEGAL_ACTION_STATUS, CM_TOT_OUT_BAL, CM_PROC_STAT,
  	 ACCT_OVERDUE_AMT, ACCT_RESCHED_RESTRU_FLAG)
	 SELECT CYC_DT2, A.ACCT_ACCT_NO, A.ACCT_STAT_CD,
	 CASE WHEN CP.IIS_LEGAL_ACTION_STATUS = '61' THEN 'Y' ELSE 'N' END AS BANKRUPT_FLG,
	 CASE WHEN CP.IIS_LEGAL_ACTION_STATUS = '61' THEN CP.IIS_TOTAL_OUTSTANDING END AS BANKRUPT_VAL,
	 CASE WHEN CL.CM_PROC_STAT IN ('CF','PC') THEN CL.CM_DATE_PROC_SET END AS CHARGE_OFF_DT ,
	 CASE WHEN CL.CM_PROC_STAT IN ('CF','PC') THEN 'Y' ELSE 'N' END AS CHARGE_OFF_FLG,
	 CL.CM_TOT_OUT_BAL, CL.CM_PMT_DUE_DT,
	 CASE WHEN A.ACCT_STAT_CD = 'CL' THEN A.ACCT_STAT_MAINT_DT END AS CLOSED_DT,
	 CASE WHEN CL.CM_WRITE_OFF_FLAG = 'P' THEN CL.CM_PWOFF_DATE
	 WHEN CL.CM_WRITE_OFF_FLAG = 'F' THEN CL.CM_WOFF_DATE END AS LST_WOFF_DT,
	 CL.CM_LST_PMT_DT,
	 CASE WHEN CL.CM_CLASS_CD = 'NP' THEN A.ACCT_OVERDUE_AMT END AS DEFAULT_AMT,
	 CASE WHEN CL.CM_CLASS_CD = 'NP' THEN 'Y' ELSE 'N' END AS DEFAULT_FLG,
	 CL.CM_LOAN_RATE,
	 CASE WHEN CL.CM_LEGAL_STAT = 'LG' THEN CL.CM_LEGAL_RECALL_DATE END AS LEGAL_DT,
	 CASE WHEN CL.CM_LEGAL_STAT = 'LG' THEN 'Y' ELSE 'N' END AS LEGAL_FLG,
	 CASE WHEN CL.CM_LEGAL_STAT = 'LG' THEN 'LG' END AS LEGAL_STAT,
	 CASE WHEN CL.CM_LEGAL_STAT = 'LG' THEN CL.CM_TOT_OUT_BAL END AS LEGAL_VAL,
	 CASE WHEN A.ACCT_STAT_CD = 'SF' THEN CL.CM_TOT_OUT_BAL END AS ONSELLING_PYMT_AMT,
	 SUBSTR(A.ACCT_PROD_CD,2,3),
	 CASE WHEN A.ACCT_RESCHED_RESTRU_FLAG = 'RT' THEN 'Y' ELSE 'N' END AS RESTRU_FLG,
	 CASE WHEN A.ACCT_RESCHED_RESTRU_FLAG = 'RT' THEN CL.CM_TOT_OUT_BAL END AS RESTRU_VAL,
	 CASE WHEN CL.CM_WRITE_OFF_FLAG = 'F' THEN CL.CM_TOT_OUT_BAL END AS WOFF_VAL,
	 CL.CM_PROC_STAT, CL.CM_ACCR_STAT, A.ACCT_ECON_SECTOR_CD, A.ACCT_CUST_SECTOR_CD,
	 A.ACCT_MATUR_DATE, CL.CM_FACILITY_CODE, A.ACCT_PYMT_AMT, A.ACCT_MATUR_DATE,
	 CL.CM_TOT_CUR_PRN_OUT, CL.CM_USER_BORROWERS, CL.CM_USER_GUARANTORS, CL.CM_PUR_OF_BOR_CD, CL.CM_TERM_INCR,
	 CASE WHEN A.ACCT_RESCHED_RESTRU_FLAG = 'RS' THEN 'Y' ELSE 'N' END AS RESCHE_FLG,
	 CASE WHEN A.ACCT_STAT_CD = 'PF' THEN CL.CM_POFF_DATE
	 WHEN A.ACCT_STAT_CD = 'CL' THEN A.ACCT_STAT_MAINT_DT END AS SETTLE_DT,
	 A.ACCT_ORI_BAL, CP.IIS_MOS_IN_ARREARS, A.ACCT_OPEN_DT,
	 CASE WHEN CL.CM_RT_RENG_CD = '1' THEN 'Y' ELSE 'N' END AS AKPK,
	 CP.IIS_SP_CLOSE_BAL, A.ACCT_TERM_OF_LOAN, CL.CM_AC_AMT_PD_MTD, CL.CM_FEE_PD_YTD, CL.CM_AC_AMT_PD_MTD, A.ACCT_SSE,
	 CP.IIS_LEGAL_ACTION_STATUS, CL.CM_TOT_OUT_BAL, CL.CM_PROC_STAT, A.ACCT_OVERDUE_AMT, A.ACCT_RESCHED_RESTRU_FLAG
	 FROM DWPROD.ACCT_HT A, DWPROD.CREDIT_PROVISIONS_HT CP, DWPROD.COMMERCIAL_LOAN_HT CL
	 
	 WHERE A.ACCT_ACCT_ID = CP.IIS_ACCT_ID
	 AND A.ACCT_ACCT_ID = CL.CM_ACCT_ID
	 AND A.ACCT_BUS_CYC_DT = CYC_DT2
	 AND CP.IIS_BUS_CYC_DT = CYC_DT2
	 AND CL.CM_BUS_CYC_DT = CYC_DT2
	 AND A.ACCT_APPL_SYS_ID = 'ALS'
	 AND CP.IIS_APPL_SYS_ID = 'ALS';

	 UPDATE BSCORE_ALS_ACCT_UAT
	 SET CUST_ID = 'NA',
	 HIGHEST_CUR_DELINQ = 'NA',
	 HIGHEST_30DAY_DELINQ = 'NA',
	 HIGHEST_60DAY_DELINQ = 'NA',
	 HIGHEST_90DAY_DELINQ = 'NA',
	 HIGHEST_120DAY_DELINQ = 'NA',
	 HIGHEST_150DAY_DELINQ = 'NA',
	 HIGHEST_180DAY_DELINQ = 'NA',
	 HIGHEST_210DAY_DELINQ = 'NA',
	 HIGHEST_240DAY_DELINQ = 'NA',
	 HIGHEST_270DAY_DELINQ = 'NA',
	 HIGHEST_300DAY_DELINQ = 'NA',
	 HIGHEST_330DAY_DELINQ = 'NA',
	 HIGHEST_360DAY_DELINQ = 'NA',
	 HIGHEST_390DAY_DELINQ = 'NA',
	 HIGHEST_DELINQ_VAL = 'NA',
	 HIGHEST_BAL_VAL = 'NA',
	 ACC_REC_AMT = 'NA',
	 BANKRUPT_DT = 'NA',
	 CARD_TYP = 'NA',
	 CHARGE_OFF_VAL = 'NA',
	 CYC_ARR_FEE_VAL = 'NA',
	 CYC_ARR_INT_VAL = 'NA',
	 CYC_ARR_VAL = 'NA',
	 CYC_CASH_ADV_CNT = 'NA',
	 CYC_CASH_ADV_VAL = 'NA',
	 CYC_CASH_ADV_LMT = 'NA',
	 CYC_CR_VAL = 'NA',
	 CYC_DB_VAL = 'NA',
	 CYC_MERCH_PURC_CNT = 'NA',
	 CYC_MERCH_PURCH_VAL = 'NA',
	 CYC_PYMT_VAL = 'NA',
	 CYC_MIN_PYMT_VAL = 'NA',
	 CYC_PAST_DUE_VAL = 'NA',
	 CARD_EXPY_DT = 'NA',
	 FST_CASH_ADV_DT = 'NA',
	 FST_MERCH_PURC_DT = 'NA',
	 LST_CASH_ADV_DT = 'NA',
	 LST_DEFAULT_DT = 'NA',
	 LST_COL_DT = 'NA',
	 LST_CR_DT = 'NA',
	 LST_TOT_ARR_VAL_DT = 'NA',
	 LST_MAINTAIN_ACCT_STAT_DT = 'NA',
	 LST_MERCH_PURC_DT = 'NA',
	 LST_OUT_DEFAULT_DT = 'NA',
	 START_OVERLMT_DT = 'NA',
	 DEFAULT_REASON = 'NA',
	 EXT_COL_DT = 'NA',
	 EXT_COL_FLG = 'NA',
	 EXT_COL_VAL = 'NA',
	 FRAUD_DT = 'NA',
	 FRAUD_FLG = 'NA',
	 FRAUD_VAL = 'NA',
	 INVOLUNTARY_CL_DT = 'NA',
	 INVOLUNTARY_CL_FLG = 'NA',
	 INVOLUNTARY_CL_VAL = 'NA',
	 LEGAL_ACT_VALUE = 'NA',
	 CYC_INT_VAL = 'NA',
	 CYC_INT_DUE = 'NA',
	 NATIONALITY = 'NA',
	 RETURN_PYMT_CNT = 'NA',
	 OD_LMT = 'NA',
	 ONSELLING_DT = 'NA',
	 ONSELLING_AMT = 'NA',
	 ONSELLING_REC = 'NA',
	 REC_SRC_CD = 'NA',
	 REC_PRIN_AMT = 'NA',
	 REC_INT_AMT = 'NA',
	 REC_COST_AMT = 'NA',
	 REC_TOT_AMT = 'NA',
	 PYMT_METHOD = 'NA',
	 PLASTIC_STAT = 'NA',
	 POSTING_CD = 'NA',
	 PREV_ACCT_STAT = 'NA',
	 PROD_CAT = 'NA',
	 REASON_CL = 'NA',
	 REC_AMT = 'NA',
	 REC_DT = 'NA',
	 REMINDER = 'NA',
	 REPYMT_AGR = 'NA',
	 RESTRU_DT = 'NA',
	 RESTRU_AGR = 'NA',
	 RETURN_STAND_INSTR_IND = 'NA',
	 STAT_CHG_DT = 'NA',
	 PAY_PROMISE_CNT = 'NA',
	 PAY_PROMISE_CNT_BROKEN = 'NA',
	 TRAN_AMT = 'NA',
	 TRAN_SEQ_NO = 'NA',
	 TRAN_CD = 'NA',
	 TRAN_SYS_CD = 'NA',
	 TRAN_DT = 'NA',
	 TRAN_POST_DT = 'NA',
	 USER_CD_1 = 'NA',
	 USER_CD_2 = 'NA',
	 USER_CD_3 = 'NA',
	 USER_CD_4 = 'NA',
	 HIGHEST_ARR_PYMT = 'NA',
	 ACCT_CD = 'NA',
	 ACCT_PRD_SER_CD = 'NA',
	 ACCT_TYP = 'NA',
	 ACC_INT = 'NA',
	 AGENT_CD = 'NA',
	 AUTHORISE_LMT = 'NA',
	 BILL_DT = 'NA',
	 CAMPAIGN_CD = 'NA',
	 CHQ_RETURN_IND = 'NA',
	 CHQ_RETURN_AMT = 'NA',
	 COLL_APPR_VAL = 'NA',
	 COLL_SALE_VAL = 'NA',
	 CYC_ARR_COMM_VAL = 'NA',
	 CYC_ARR_PEN_VAL = 'NA',
	 CYC_ARR_PRIN_VAL = 'NA',
	 CYC_AVAIL_BAL_VAL = 'NA',
	 CYC_DY = 'NA',
	 CYC_LATE_CHARG_VAL = 'NA',
	 CYC_MISC_CHARG_VAL = 'NA',
	 CYC_WITHDRAW_LMT = 'NA',
	 CYC_LED_BAL_VAL = 'NA',
	 LST_CR_TXN_DT = 'NA',
	 LST_DR_TXN_DT = 'NA',
	 LST_TXN_DT = 'NA',
	 OVERLMT_DT = 'NA',
	 FAC_TYP = 'NA',
	 INSURE_OS_IND = 'NA',
	 LEGAL_ACT_DT = 'NA',
	 LEGAL_ACT_FLG = 'NA',
	 LOAN_TYP = 'NA',
	 PURPOSES = 'NA',
	 ME_INSTALL_ARR_AMT = 'NA',
	 CYC_CR_CNT = 'NA',
	 CYC_CR_VAL_CA = 'NA',
	 CYC_DR_CNT = 'NA',
	 CYC_DR_VAL_CA = 'NA',
	 MRTA_IND = 'NA',
	 OFFICER_CD = 'NA',
	 PROD_GRP = 'NA',
	 PROD_ORIG_BRN = 'NA',
	 PROD_SCH_TYP = 'NA',
	 PROD_TYP_DESC = 'NA',
	 RESTRU_PERIOD = 'NA',
	 SALARY_IND = 'NA',
	 SECTOR_CD = 'NA',
	 SRC_CD = 'NA',
	 STANDING_INSTR_AMT = 'NA',
	 STANDING_INSTR_IND = 'NA',
	 SUB_TYP = 'NA',
	 TOT_OD_DRAWDOWN_AMT = 'NA',
	 SUB_PURPOSE = 'NA',
	 MAIN_TYP = 'NA',
	 TXN_DESC = 'NA',
	 CYC_BAL_VAL_WITHO_EPP = 'NA',
	 UNBILL_EPP = 'NA',
	 EPP_1ST_INSTALL_AMT = 'NA',
	 COLL_VAL = 'NA',
	 MTD_LOWEST_BAL_AMT = 'NA',
	 MTD_TOT_BAL_AMT = 'NA',
	 MTD_TOT_DAYS = 'NA',
	 MTD_WITHDRAW_CNT = 'NA',
	 MTD_WITHDRAW_AMT = 'NA',
	 MTD_DEP_CNT = 'NA',
	 MTD_DEP_AMT = 'NA',
	 SAV_HOLD_FULL_AMT_IND = 'NA',
	 SAV_FLOAT_AMT = 'NA',
	 SAV_MIN_AMT = 'NA',
	 SAV_HOLD_AMT = 'NA',
	 GL_GRP_CD = 'NA',
	 LOAN_GRP = 'NA',
	 RETAIL_OD = 'NA',
	 REPYMT_PRIN = 'NA',
	 EXCESS_VAL = 'NA';

	 --COMMIT;

	 INSERT INTO BSCORE_PROC_LOG(SYS_ID, BUS_CYC_DT, PROCESS_MSG, PROC_DT)
	 VALUES ('ALS', CYC_DT2, 'END INSERT BSCORE_ALS_ACCT', LOCALTIMESTAMP);
	 --COMMIT;

END;
$$
LANGUAGE PLPGSQL;

