------
--DEV BY : Jitendra Lodwal  
--DATE  : 25-AUG-2011 
--DESC : FUNCTION
------

SET SEARCH_PATH TO WORKAREA;

CREATE OR REPLACE FUNCTION Mep_Sub_Als_Insert() RETURNS VOID AS $$
 BEGIN
--ALS
--deli
TRUNCATE TABLE MEP_DELI_ALS;
INSERT INTO MEP_DELI_ALS(MDL_ACCT_NO, MDL_APPL_SYS_ID, MDL_CYC_DT,
MDL_MIA, MDL_MIA_AMT, MDL_LOG_DT)
SELECT A.ACCT_ACCT_NO MDL_ACCT_NO, A.ACCT_APPL_SYS_ID MDL_APPL_SYS_ID,
A.ACCT_BUS_CYC_DT MDL_CYC_DT, B.IIS_MOS_IN_ARREARS MDL_MIA,
A.ACCT_OVERDUE_AMT MDL_MIA_AMT, LOCALTIMESTAMP MDL_LOG_DT
FROM  dwprod.acct_ht_1_prt_acct_ht_201106  A , dwprod.credit_provisions_ht_1_prt_credit_provisions_ht_201106  B
WHERE A.ACCT_ACCT_NO   = B.IIS_ACCT_NO
AND A.ACCT_APPL_SYS_ID = 'ALS';
--COMMIT;
--overlimit

TRUNCATE TABLE MEP_OVLIMIT_ALS;

INSERT INTO MEP_OVLIMIT_ALS(MO_ACCT_NO,MO_APPL_SYS_ID,MO_CYC_DT,MO_OVLIMIT_IND,MO_LOG_DT,MO_OS_AMT)
SELECT ACCT_ACCT_NO  MO_ACCT_NO, ACCT_APPL_SYS_ID MO_APPL_SYS_ID,
ACCT_BUS_CYC_DT MO_CYC_DT, CASE WHEN ACCT_CUR_BAL > ACCT_LIMIT_AMT
THEN 'Y' ELSE 'N' END AS MO_OVLIMIT_IND,LOCALTIMESTAMP  MO_LOG_DT,
CM_TOT_OUT_BAL MO_OS_AMT
FROM dwprod.acct_ht_1_prt_acct_ht_201106 , dwprod.commercial_loan_ht_1_prt_commercial_loan_ht_201106 
WHERE ACCT_ACCT_NO = CM_ACCT_NO
AND ACCT_APPL_SYS_ID = 'ALS'  ;
--COMMIT;


--status
TRUNCATE TABLE MEP_STATUS_ALS;

INSERT INTO MEP_STATUS_ALS(MS_ACCT_NO,MS_APPL_SYS_ID,MS_CYC_DT,MS_STAT_CD,
MS_STAT_RANK,MS_LOG_DT,MS_WOFF_IND)
SELECT  A.ACCT_ACCT_NO MS_ACCT_NO, A.ACCT_APPL_SYS_ID MS_APPL_SYS_ID, A.ACCT_BUS_CYC_DT MS_CYC_DT,
A.ACCT_STAT_CD  MS_STAT_CD, B.MSR_STAT_RANK MS_STAT_RANK, LOCALTIMESTAMP  MS_LOG_DT ,
CASE WHEN C.IIS_WRITE_OFF_STAT ='X'THEN 'Y' ELSE 'N' END AS MS_WOFF_IND
FROM  dwprod.acct_ht_1_prt_acct_ht_201106 A, dwprod.credit_provisions_ht_1_prt_credit_provisions_ht_201106   C, MEP_STAT_RANK B
WHERE A.ACCT_APPL_SYS_ID = 'ALS'
AND A.ACCT_STAT_CD    = B.MSR_STAT_CD
AND B.MSR_APPL_SYS_ID = 'ALS'
AND A.ACCT_ACCT_NO=C.IIS_ACCT_NO;

TRUNCATE TABLE MEP_COLLAT_ALS;

INSERT INTO MEP_COLLAT_ALS(MC_ACCT_NO,MC_APPL_SYS_ID, MC_CYC_DT,
MC_PROP_FCLOS_AUCTION_DT)
SELECT A.ACCT_ACCT_NO, A.ACCT_APPL_SYS_ID , ACCT_BUS_CYC_DT,
PROP_FCLOS_AUCTION_DT
FROM dwprod.acct_ht_1_prt_acct_ht_201106  A,dwprod.collat_acct_rel_ht_1_prt_collat_acct_rel_ht_201106  B,
DWPROD.COLLAT_PROP_HT   C
WHERE A.ACCT_ACCT_NO = B.COAR_R_ACCT_NO
AND   B.COAR_COLL_NO  = C.PROP_COLL_NO
AND   A.ACCT_APPL_SYS_ID = 'ALS';

--COMMIT;
END;
$$
LANGUAGE PLPGSQL;

