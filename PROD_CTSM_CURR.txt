------
--DEV BY : Jitendra Lodwal  
--DATE  : 06-SEP-2011 
--DESC : FUNCTION
------

SET SEARCH_PATH TO WORKAREA;

CREATE OR REPLACE FUNCTION PROD_CTSM_CURR() RETURNS VOID AS $$
DECLARE
PREV_DT        DATE ;
CURR_DT        DATE ;
NEXT_DT        DATE ; 
REPORT_DT_FLG VARCHAR(1);
REPORT_DT      DATE;
--CREATED BY EVON 19JAN2010
BEGIN 

SELECT COUNT(*)
INTO REPORT_DT_FLG
FROM DWPROD.SSYSCYC 
WHERE SC_FREQUENCY ='D'
AND SC_STAT_CD = ' '
AND SC_PROC_ID='DELTA'
AND TO_CHAR(SC_CURR_CYC,'DD') IN ('08','19','22') ;

IF REPORT_DT_FLG = 0 THEN  
 SELECT COUNT(*)
 INTO REPORT_DT_FLG
 FROM CTSM_REPORT_DT ,DWPROD.SSYSCYC
 WHERE SC_CURR_CYC =NEXT_ME_DT
 AND  SC_FREQUENCY ='M'
 AND SC_STAT_CD = ' '
 AND SC_PROC_ID='DELTA';
END IF ; 

IF REPORT_DT_FLG = 1  THEN 
   SELECT SC_CURR_CYC
   INTO REPORT_DT 
   FROM DWPROD.SSYSCYC 
   WHERE SC_FREQUENCY ='D'
   AND SC_STAT_CD = ' '
   AND SC_PROC_ID='DELTA';
    
  -- REPORT_DT := '31-DEC-2009';
   
   
  TRUNCATE TABLE CTSM;
  TRUNCATE TABLE CTSM_TXD;
  TRUNCATE TABLE CTSM_TXD_SUM;
   
   INSERT INTO CTSM
 SELECT DISTINCT REPORT_DT,'CA',CAR_CUST_KEY, CAR_C_CIF_NO,ACCT_ACCT_NO,ACCT_ACCT_ID,CUS_NM_LINE,
          CAR_PRIMARY_ID,ACCT_ECON_SECTOR_CD,ACCT_RM_CODE,ACCT_OPEN_DT,ACCT_STAT_CD,
          NP_CUST_DOI,ACCT_LIMIT_AMT,0,0,ACCT_CUR_BAL
   FROM   DWPROD.ACCT, 
DWPROD.CUST_ACCT_REL 
LEFT OUTER JOIN DWPROD.CUST ON  CAR_CUST_KEY =CUS_KEY
LEFT OUTER JOIN DWPROD.CUST_NON_PERS ON CAR_CUST_KEY = NP_CUST_KEY
  WHERE   ACCT_ACCT_ID =CAR_R_ACCT_ID
   AND    ACCT_APPL_SYS_ID ='IMS'
   AND    CUS_TYP_CD ='O';

   
   INSERT INTO CTSM
   SELECT DISTINCT REPORT_DT,'FD',CAR_CUST_KEY, 
          CAR_C_CIF_NO,A.ACCT_ACCT_NO,A.ACCT_ACCT_ID,CUS_NM_LINE,
          CAR_PRIMARY_ID,A.ACCT_ECON_SECTOR_CD,
          A.ACCT_RM_CODE,A.ACCT_OPEN_DT,A.ACCT_STAT_CD,
          NP_CUST_DOI,A.ACCT_LIMIT_AMT,0,0,A.ACCT_CUR_BAL
   FROM   CTSM C,DWPROD.ACCT A,DWPROD.CUST_ACCT_REL
LEFT OUTER JOIN DWPROD.CUST ON  CAR_CUST_KEY =CUS_KEY
LEFT OUTER JOIN DWPROD.CUST_NON_PERS ON CAR_CUST_KEY = NP_CUST_KEY   WHERE  C.CUSTOMER_KEY =CAR_CUST_KEY 
   AND    ACCT_ACCT_ID =CAR_R_ACCT_ID
   AND    ACCT_APPL_SYS_ID ='STS'
   AND    SUBSTR(ACCT_ACCT_NO , 9,3) IN ('003','004','013')
   AND    CUS_TYP_CD ='O';
   --COMMIT;
   
   INSERT INTO CTSM_TXD 
   SELECT TXD_ACCT_ID ,TXD_CYC_DT, sum(foo.SUM_DB) AS TOT_DB, sum(foo.SUM_CR) AS TOT_CR
   FROM (
   SELECT TXD_ACCT_ID ,TXD_CYC_DT,
   0 as SUM_DB,count(TXD_DR_CR_INQ_TYP) AS SUM_CR
   FROM DWPROD.TRAN_DETAIL ,CTSM
   WHERE ACCT_ID = TXD_ACCT_ID
   AND TXD_APPL_SYS_ID = 'IMS'
   AND TXD_DR_CR_INQ_TYP IN ('1','2')
   GROUP BY TXD_ACCT_ID,TXD_CYC_DT
   union
   SELECT TXD_ACCT_ID ,TXD_CYC_DT,
   count(TXD_DR_CR_INQ_TYP) AS SUM_DB,0 AS SUM_CR
   FROM DWPROD.TRAN_DETAIL ,CTSM
   WHERE ACCT_ID = TXD_ACCT_ID
   AND TXD_APPL_SYS_ID = 'IMS'
   AND TXD_DR_CR_INQ_TYP IN ('3','4')
   GROUP BY TXD_ACCT_ID,TXD_CYC_DT) as foo
   GROUP BY TXD_ACCT_ID,TXD_CYC_DT;
   --COMMIT;
   
   INSERT INTO CTSM_TXD 
   SELECT TXD_ACCT_ID ,TXD_CYC_DT,sum(foo.SUM_DB) AS TOT_DB, sum(foo.SUM_CR) AS TOT_CR
   FROM (
   SELECT TXD_ACCT_ID ,TXD_CYC_DT,
   0 as SUM_DB,count(TXD_DR_CR_INQ_TYP) AS SUM_CR
   FROM DWPROD.TRAN_DETAIL ,CTSM
   WHERE ACCT_ID = TXD_ACCT_ID
   AND TXD_APPL_SYS_ID = 'STS'
   AND TXD_DR_CR_INQ_TYP =2
   GROUP BY TXD_ACCT_ID,TXD_CYC_DT
   union
   SELECT TXD_ACCT_ID ,TXD_CYC_DT,
   count(TXD_DR_CR_INQ_TYP) AS SUM_DB,0 AS SUM_CR
   FROM DWPROD.TRAN_DETAIL ,CTSM
   WHERE ACCT_ID = TXD_ACCT_ID
   AND TXD_APPL_SYS_ID = 'STS'
   AND TXD_DR_CR_INQ_TYP =1
   GROUP BY TXD_ACCT_ID,TXD_CYC_DT) as foo
   GROUP BY TXD_ACCT_ID,TXD_CYC_DT;
   --COMMIT;
   
   insert into CTSM_TXD_SUM
   SELECT TXD_ACCT_ID,SUM(TOT_DB) ,SUM(TOT_CR)
   FROM CTSM_TXD
   WHERE TXD_CYC_DT BETWEEN REPORT_DT-59  AND REPORT_DT
   GROUP BY TXD_ACCT_ID;
   --COMMIT;

   UPDATE CTSM C SET TOT_DB =(SELECT D.TOT_DB                                                                                              
  FROM CTSM_TXD_SUM D,CTSM C                                                                                                                             
WHERE D.TXD_ACCT_ID =C.ACCT_ID );

   --COMMIT;
   
   UPDATE CTSM C SET TOT_CR =(SELECT D.TOT_CR
   FROM CTSM_TXD_SUM D, CTSM C
   WHERE D.TXD_ACCT_ID =C.ACCT_ID );
   --COMMIT;
		 
 
    SELECT SC_PREV_CYC,SC_CURR_CYC,SC_NEXT_CYC
    INTO PREV_DT,CURR_DT,NEXT_DT 
    FROM DWPROD.SSYSCYC
    WHERE  SC_FREQUENCY ='M'
    AND SC_STAT_CD = ' '
    AND SC_PROC_ID='DELTA';
	
    UPDATE CTSM_REPORT_DT SET PREVIOUS_ME_DT  = PREV_DT,     
    CURR_ME_DT      = CURR_DT,     NEXT_ME_DT      = NEXT_DT ;   
	--COMMIT;     
	 
 END IF;
END ;


$$
LANGUAGE PLPGSQL;

