------
--DEV BY : Jitendra Lodwal  
--DATE  : 26-AUG-2011 
--DESC : FUNCTION
------

SET SEARCH_PATH TO WORKAREA;

CREATE OR REPLACE FUNCTION PROC_CUST_PRODUCT() RETURNS VOID AS $$

BEGIN

INSERT INTO CUST_PRODUCT(APPL_SYS_ID,PROD_CD,ACCT_STATUS_CD,FIVE_GROUP,STATUS,NOCUST)
SELECT B.APPL_SYS_ID ,B.PROD_CD,B.ACCT_STATUS_CD,A.FIVE_GROUP,'NA',COUNT (DISTINCT B.CUST_KEY) AS NoCust
	   FROM CUST_ACCT B,CUST_AGE A
	   		WHERE (A.CUST_KEY = B.CUST_KEY)
				  AND B.APPL_SYS_ID IN ('ALS','CPS','ICS','IMS','STS','LIF')
				  	 GROUP BY (B.APPL_SYS_ID,A.FIVE_GROUP,B.PROD_CD,B.ACCT_STATUS_CD,B.STATUS)
					 		ORDER BY B.APPL_SYS_ID,A.FIVE_GROUP,B.PROD_CD,B.ACCT_STATUS_CD,B.STATUS;
--COMMIT;

INSERT INTO CUST_PRODUCT(APPL_SYS_ID,PROD_CD,ACCT_STATUS_CD,FIVE_GROUP,STATUS,NOCUST)
SELECT B.APPL_SYS_ID ,B.PROD_CD,B.ACCT_STATUS_CD,A.FIVE_GROUP,B.STATUS,COUNT (DISTINCT B.CUST_KEY) AS NoCust
	   FROM CUST_ACCT B,CUST_AGE A
	   		WHERE (A.CUST_KEY = B.CUST_KEY)
				  AND B.APPL_SYS_ID = 'GEN'
				  	 GROUP BY (B.APPL_SYS_ID,A.FIVE_GROUP,B.PROD_CD,B.ACCT_STATUS_CD,B.STATUS)
					 		ORDER BY B.APPL_SYS_ID,A.FIVE_GROUP,B.PROD_CD,B.ACCT_STATUS_CD,B.STATUS;

--COMMIT;
END;
$$
LANGUAGE PLPGSQL;

