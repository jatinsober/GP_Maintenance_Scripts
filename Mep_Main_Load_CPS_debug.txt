------
--DEV BY : Jitendra Lodwal  
--DATE  : 02-Sep-2011 
--DESC : FUNCTION
------

SET SEARCH_PATH TO WORKAREA;

CREATE OR REPLACE PROCEDURE Mep_Main_Load_Cps (P_DATE IN DATE) RETURNS VOID AS $$
P_RPT_DT  DATE;
BEGIN
P_RPT_DT := P_DATE; --END DATE
		BEGIN
		INSERT INTO MEP_LOG_CPS (ML_CYC_DT,ML_PROCESS_NAME,ML_RUN_START )
		VALUES  (P_DATE,'INSERT MEP_DTL_CPS_EXT FOR CPS',TO_CHAR(LOCALTIMESTAMP, 'DD-MON-YYYY HH:MI:SS AM') );
		
        TRUNCATE TABLE MTR_LOG_CPS ;
        TRUNCATE TABLE MEP_DTL_CPS_TEMP;
	    TRUNCATE TABLE MEP_DTL_CPS;
	    TRUNCATE TABLE MEP_DTL_CPS_EXT;
		-- FOR CPS EXTRACTION  PART 1


        INSERT INTO MEP_DTL_CPS_EXT (MD_ACCT_NO, MD_REPORT_DT,MD_ACCT_ID,
        MD_ENTITY,MD_PRODUCT,MD_APPL_SYS_ID,MD_ACCT_OPEN_DT,MD_PROD_CD,MD_ACCT_STAT,
        MD_CARD_STAT,MD_CYCLE_CPS,MD_BLOCK_CD,MD_MTH_ON_BOOK,MD_LN_AGE,MD_LN_TERM,
	    MD_PRINC_LN_AMT, MD_OS_AMT,MD_LN_OPEN_DT,MD_LN_PURPOSE,MD_LN_SUB_PROD,
        MD_ACCT_TYP_CD,MD_WOFF_IND, MD_AUTO_DBT_IND,MD_CRDT_LMT,MD_CASH_ADV_LMT,
	    MD_LST_PYMT_AMT, MD_LST_CRDT_LMT_DT,MD_LST_PYMT_DT,MD_UTILIZTN,MD_INSTALL_LMT,
		MD_MTH_AMORT,MD_DPD_AMT1,MD_DPD_AMT2,MD_DPD_AMT3,MD_DPD_AMT4,MD_RETAIL_BAL,MD_RENEW_DT,
	    MD_PAST_DUE,MD_OVER_LMT_CNT_L1M,MD_AKPK,MD_WATCHLIST_FLAG,MD_WATCH_DATE,
		MD_NON_ACCRUAL,MD_PRINC_CARD_NO,
		--MD_SUPPL_HOLDER_NO,
		MD_PAYMENT,
		MD_CLOSED)

	 SELECT DISTINCT B.VM_CARD_IND_ACCT_NO AS MD_ACCT_NO,A.ACCT_BUS_CYC_DT MD_REPORT_DT,A.ACCT_ACCT_ID,
	      CASE WHEN UPPER(P.PROD_GRP_SHORT_DESC) = 'ISCC' THEN 'AMI' ELSE 'AMB' END AS MD_ENTITY,
          P.PROD_SHORT_DESC MD_PRODUCT, A.ACCT_APPL_SYS_ID MD_APPL_SYS_ID,
          A.ACCT_OPEN_DT MD_ACCT_OPEN_DT, P.PROD_SHORT_DESC MD_PROD_CD, A.ACCT_STAT_CD MD_ACCT_STAT,
          A.ACCT_RESTR_ACCS_CD MD_CARD_STAT, A.ACCT_CYC_CD MD_CYCLE_CPS,A.ACCT_RESTR_ACCS_CD MD_BLOCK_CD,
          ROUND((CAST(A.ACCT_BUS_CYC_DT AS DATE) - CAST(A.ACCT_LIMIT_APPR_DT AS DATE)) / 30,0) MD_MTH_ON_BOOK,
          ROUND((CAST(A.ACCT_BUS_CYC_DT AS DATE) - CAST(A.ACCT_LIMIT_APPR_DT AS DATE)) / 30,0) MD_LN_AGE, A.ACCT_TERM_OF_LOAN MD_LN_TERM,
		  A.ACCT_LIMIT_AMT MD_PRINC_LN_AMT,  A.ACCT_CUR_BAL MD_OS_AMT,A.ACCT_OPEN_DT MD_LN_OPEN_DT,
          P.PROD_GRP_LONG_DESC MD_LN_PURPOSE,A.ACCT_PROD_CD MD_LN_SUB_PROD,
          A.ACCT_TYP_CD MD_ACCT_TYP_CD,
          CASE WHEN A.ACCT_STAT_CD IN ('R','W') THEN 'Y' ELSE 'N' END AS MD_WOFF_IND,
          CASE WHEN B.VM_AT_PMT_FG > 0 THEN 'Y' ELSE 'N' END AS MD_AUTO_DBT_IND,
          B.VM_CRLIMIT_PERM MD_CRDT_LMT, B.VM_CRLIMIT_PERM MD_CASH_ADV_LMT,
          B.VM_LST_PMT_AMT MD_LST_PYMT_AMT,
          CASE WHEN B.VM_LS_CR_LM_CHG_DT = '01-JAN-0001' THEN NULL
          ELSE B.VM_LS_CR_LM_CHG_DT END AS MD_LST_CRDT_LMT_DT,
          B.VM_LST_PMT_DT MD_LST_PYMT_DT,
          CASE WHEN B.VM_CRLIMIT_PERM > 0 THEN ROUND(COALESCE(A.ACCT_CUR_BAL,0) / COALESCE(B.VM_CRLIMIT_PERM,0),2)
          ELSE 0 END AS MD_UTILIZTN,
          100 MD_MD_INSTALL_LMT,B.VM_PAST_DUE_AMT MD_MTH_AMORT,
          B.VM_PAST_DUE_AMT MD_DPD_AMT1, B.VM_D30_DYS_AMT MD_DPD_AMT2, B.VM_D60_DYS_AMT MD_DPD_AMT3,
          B.VM_D90_DYS_AMT MD_DPD_AMT4,B.VM_MNTH_END_BAL MD_RETAIL_BAL, B.VM_LST_EXPIR_DTE MD_RENEW_DT,
		  CASE WHEN B.VM_MIA='CR' THEN 0 ELSE CAST(B.VM_MIA AS NUMERIC)  END AS MD_PAST_DUE,
		  CASE WHEN B.VM_OL_FLAG='1' THEN 1 ELSE 0 END AS MD_OVER_LMT_CNT_L1M,
          CASE WHEN VM_USER_CODE IN ('85','86','87','88','89') THEN 'Y' ELSE 'N' END AS AKPK,
		  SUBSTR(B.VM_WATCHLIST,1,1) AS WATCHLIST_FLAG,
          B.VM_WATCH_DATE  AS WATCHLIST_DT,
		  CASE WHEN  A.ACCT_NPL_STAT IN ('D','E','N','S','W') THEN 'Y' ELSE 'N' END AS NON_ACCRUAL,
		  D.AAR_R_ACCT_NO AS PRINC_CARD_NO,
		  T.TXD_CASH_AMT AS PAYMENT,
		  CASE WHEN A.ACCT_STAT_CD IN ('C','V') AND A.ACCT_RESTR_ACCS_CD = 'O' AND
		  ACCT_CARD_FEE_CD = '097' THEN  'Y' ELSE 'N' END  AS CLOSED
 		  FROM ACCT_HT_CPS A 
LEFT OUTER JOIN MEP_PRODUCT_CPS P ON TRIM(A.ACCT_PROD_CD) = TRIM(P.PROD_PROD_CD)
LEFT OUTER JOIN ACCT_ACCT_REL_CPS D ON A.ACCT_ACCT_NO = D.AAR_R_ACCT_NO
LEFT OUTER JOIN MEP_TRAN_DETAIL_CPS_ME T ON A.ACCT_ACCT_ID = T.TXD_ACCT_ID
,CARD_CREDIT_LINE_HT_CPS B
			   WHERE A.ACCT_ACCT_NO = B.VM_ACCT_NO
		   AND A.ACCT_BUS_CYC_DT = P_RPT_DT;
		  

	 INSERT INTO MEP_DTL_CPS_TEMP(MD_REPORT_DT,MD_ACCT_NO,MD_ACCT_ID,
	                              MD_PREV_DELI,MD_PREV_BAL_OS,MD_PREV_CRDT_LMT)
        SELECT MD_REPORT_DT,MD_ACCT_NO,MD_ACCT_ID,
	    CASE WHEN VM_MIA ='CR' THEN 0 ELSE TO_NUMBER(VM_MIA) END AS MD_PREV_DELI,ACCT_CUR_BAL,
		VM_CRLIMIT_PERM
        FROM MEP_DTL_CPS_EXT, ACCT_HT_CPS_PREV A,CARD_CREDIT_LINE_HT_CPS_PREV C
        WHERE MD_ACCT_ID = ACCT_ACCT_ID (+)
        AND MD_ACCT_ID =VM_ACCT_ID(+);



		INSERT INTO MEP_DTL_CPS (MD_ACCT_NO,MD_REPORT_DT,MD_ACCT_ID,
          MD_ENTITY,MD_PRODUCT,MD_APPL_SYS_ID,MD_ACCT_OPEN_DT,MD_PROD_CD,MD_ACCT_STAT,
          MD_CARD_STAT,MD_CYCLE_CPS,MD_BLOCK_CD,MD_MTH_ON_BOOK,MD_LN_AGE,MD_LN_TERM,
		  MD_PRINC_LN_AMT, MD_OS_AMT,MD_LN_OPEN_DT,MD_LN_PURPOSE,MD_LN_SUB_PROD,
          MD_ACCT_TYP_CD,MD_WOFF_IND, MD_AUTO_DBT_IND,MD_CRDT_LMT,MD_CASH_ADV_LMT,
		  MD_LST_PYMT_AMT, MD_LST_CRDT_LMT_DT, MD_LST_PYMT_DT,MD_UTILIZTN,MD_INSTALL_LMT,MD_MTH_AMORT,
          MD_DPD_AMT1,MD_DPD_AMT2,MD_DPD_AMT3,MD_DPD_AMT4,MD_RETAIL_BAL,MD_RENEW_DT,MD_PAST_DUE,
		  MD_OVER_LMT_CNT_L1M,MD_PREV_DELI,MD_PREV_BAL_OS,MD_PREV_CRDT_LMT,
		  MD_AKPK,MD_WATCHLIST_FLAG,MD_WATCH_DATE,MD_NON_ACCRUAL,MD_PRINC_CARD_NO,
		  MD_SUPPL_HOLDER_NO,MD_PAYMENT,MD_CLOSED)
		SELECT  DISTINCT E.MD_ACCT_NO, E.MD_REPORT_DT,E.MD_ACCT_ID,
          E.MD_ENTITY,E.MD_PRODUCT,E.MD_APPL_SYS_ID,E.MD_ACCT_OPEN_DT,E.MD_PROD_CD,E.MD_ACCT_STAT,
          E.MD_CARD_STAT,E.MD_CYCLE_CPS,E.MD_BLOCK_CD,E.MD_MTH_ON_BOOK,E.MD_LN_AGE,E.MD_LN_TERM,
		  E.MD_PRINC_LN_AMT, E.MD_OS_AMT,E.MD_LN_OPEN_DT,E.MD_LN_PURPOSE,E.MD_LN_SUB_PROD,
          E.MD_ACCT_TYP_CD,E.MD_WOFF_IND, E.MD_AUTO_DBT_IND,E.MD_CRDT_LMT,E.MD_CASH_ADV_LMT,
		  E.MD_LST_PYMT_AMT, E.MD_LST_CRDT_LMT_DT, E.MD_LST_PYMT_DT,E.MD_UTILIZTN,E.MD_INSTALL_LMT,E.MD_MTH_AMORT,
          E.MD_DPD_AMT1,E.MD_DPD_AMT2,E.MD_DPD_AMT3,E.MD_DPD_AMT4,E.MD_RETAIL_BAL,E.MD_RENEW_DT,E.MD_PAST_DUE,
		  E.MD_OVER_LMT_CNT_L1M,
		  T.MD_PREV_DELI,T.MD_PREV_BAL_OS,T.MD_PREV_CRDT_LMT,
		  E.MD_AKPK,MD_WATCHLIST_FLAG,E.MD_WATCH_DATE,
		  E.MD_NON_ACCRUAL,E.MD_PRINC_CARD_NO,E.MD_SUPPL_HOLDER_NO,E.MD_PAYMENT,E.MD_CLOSED
		FROM MEP_DTL_CPS_EXT E,MEP_DTL_CPS_TEMP T
        WHERE E.MD_ACCT_ID = T.MD_ACCT_ID ;
		


	    UPDATE MEP_DTL_CPS A
        SET  MD_LN_SUPP_IND='Y'
        WHERE A.MD_ACCT_ID IN (SELECT AAR_R_ACCT_ID
        FROM ACCT_ACCT_REL_CPS ,MEP_DTL_CPS B
        WHERE AAR_R_APPL_SYS_ID ='CPS'
--	    AND AAR_ACCT_NO <>B.MD_ACCT_NO
	    AND B.MD_ACCT_NO =AAR_R_ACCT_NO
	    AND MD_ACCT_TYP_CD='B');
        

        UPDATE MEP_DTL_CPS
        SET MD_LN_SUPP_IND='N'
        WHERE MD_LN_SUPP_IND IS NULL ;
        --AND MD_ACCT_TYP_CD='B';
        


	    EXECUTE IMMEDIATE 'TRUNCATE TABLE MEP_DTL_CPS_TEMP';

	    INSERT INTO MEP_DTL_CPS_TEMP (MD_ACCT_NO,MD_SUPP_CNT)
        SELECT AAR_R_ACCT_NO,COUNT(AAR_R_ACCT_NO)
		FROM ACCT_ACCT_REL_CPS ,MEP_DTL_CPS A
        WHERE AAR_R_APPL_SYS_ID ='CPS'
        AND A.MD_ACCT_NO =AAR_R_ACCT_NO
       -- AND AAR_ACCT_NO <>A.MD_ACCT_NO
        AND A.MD_ACCT_TYP_CD='B'
        AND A.MD_LN_SUPP_IND='Y'
		AND A.MD_PREV_DELI IS NOT NULL
        GROUP BY AAR_R_ACCT_NO;

 	    UPDATE MEP_DTL_CPS_TEMP
        SET MD_SUPP_CNT=0
        WHERE MD_SUPP_CNT IS NULL;
        

		EXECUTE IMMEDIATE 'TRUNCATE TABLE MEP_DTL_CPS_EXT';
		INSERT INTO MEP_DTL_CPS_EXT (MD_ACCT_NO,MD_REPORT_DT,MD_ACCT_ID,
          MD_ENTITY,MD_PRODUCT,MD_APPL_SYS_ID,MD_ACCT_OPEN_DT,MD_PROD_CD,MD_ACCT_STAT,
          MD_CARD_STAT,MD_CYCLE_CPS,MD_BLOCK_CD,MD_MTH_ON_BOOK,MD_LN_AGE,MD_LN_TERM,
		  MD_PRINC_LN_AMT, MD_OS_AMT,MD_LN_OPEN_DT,MD_LN_PURPOSE,MD_LN_SUB_PROD,
          MD_ACCT_TYP_CD,MD_WOFF_IND, MD_AUTO_DBT_IND,MD_CRDT_LMT,MD_CASH_ADV_LMT,
		  MD_LST_PYMT_AMT, MD_LST_CRDT_LMT_DT, MD_LST_PYMT_DT,MD_UTILIZTN,MD_INSTALL_LMT,MD_MTH_AMORT,
          MD_DPD_AMT1,MD_DPD_AMT2,MD_DPD_AMT3,MD_DPD_AMT4,MD_RETAIL_BAL,MD_RENEW_DT,MD_PAST_DUE,
		  MD_OVER_LMT_CNT_L1M,MD_PREV_DELI,MD_PREV_BAL_OS,MD_PREV_CRDT_LMT,MD_LN_SUPP_IND,
		  MD_SUPP_CNT,MD_AKPK,MD_WATCHLIST_FLAG,MD_WATCH_DATE, MD_NON_ACCRUAL,
		  MD_PRINC_CARD_NO,MD_SUPPL_HOLDER_NO,MD_PAYMENT,MD_CLOSED
		  )
		  SELECT  DISTINCT A.MD_ACCT_NO ,A.MD_REPORT_DT,A.MD_ACCT_ID,
          A.MD_ENTITY,A.MD_PRODUCT,A.MD_APPL_SYS_ID,A.MD_ACCT_OPEN_DT,A.MD_PROD_CD,A.MD_ACCT_STAT,
          A.MD_CARD_STAT,A.MD_CYCLE_CPS,A.MD_BLOCK_CD,A.MD_MTH_ON_BOOK,A.MD_LN_AGE,A.MD_LN_TERM,
		  A.MD_PRINC_LN_AMT, A.MD_OS_AMT,A.MD_LN_OPEN_DT,A.MD_LN_PURPOSE,A.MD_LN_SUB_PROD,
          A.MD_ACCT_TYP_CD,A.MD_WOFF_IND, A.MD_AUTO_DBT_IND,A.MD_CRDT_LMT,A.MD_CASH_ADV_LMT,
		  A.MD_LST_PYMT_AMT, A.MD_LST_CRDT_LMT_DT, A.MD_LST_PYMT_DT,A.MD_UTILIZTN,A.MD_INSTALL_LMT,A.MD_MTH_AMORT,
          A.MD_DPD_AMT1,A.MD_DPD_AMT2,A.MD_DPD_AMT3,A.MD_DPD_AMT4,A.MD_RETAIL_BAL,A.MD_RENEW_DT,A.MD_PAST_DUE,
		  A.MD_OVER_LMT_CNT_L1M,A.MD_PREV_DELI,A.MD_PREV_BAL_OS,A.MD_PREV_CRDT_LMT,A.MD_LN_SUPP_IND,
		  B.MD_SUPP_CNT,A.MD_AKPK,A.MD_WATCHLIST_FLAG,A.MD_WATCH_DATE,
		  A.MD_NON_ACCRUAL,A.MD_PRINC_CARD_NO,A.MD_SUPPL_HOLDER_NO,A.MD_PAYMENT,A.MD_CLOSED
		  FROM MEP_DTL_CPS A, MEP_DTL_CPS_TEMP B
		  WHERE A.MD_ACCT_NO =B.MD_ACCT_NO (+);
		  

		  EXECUTE IMMEDIATE 'TRUNCATE TABLE MEP_DTL_CPS';

		  INSERT INTO MEP_DTL_CPS (MD_REPORT_DT,MD_ACCT_NO,MD_ACCT_ID,
          MD_ENTITY,MD_PRODUCT,MD_APPL_SYS_ID,MD_ACCT_OPEN_DT,MD_PROD_CD,MD_ACCT_STAT,
          MD_CARD_STAT,MD_CYCLE_CPS,MD_BLOCK_CD,MD_MTH_ON_BOOK,MD_LN_AGE,MD_LN_TERM,
		  MD_PRINC_LN_AMT, MD_OS_AMT,MD_LN_OPEN_DT,MD_LN_PURPOSE,MD_LN_SUB_PROD,
          MD_ACCT_TYP_CD,MD_WOFF_IND, MD_AUTO_DBT_IND,MD_CRDT_LMT,MD_CASH_ADV_LMT,
		  MD_LST_PYMT_AMT, MD_LST_CRDT_LMT_DT, MD_LST_PYMT_DT,MD_UTILIZTN,MD_INSTALL_LMT,MD_MTH_AMORT,
          MD_DPD_AMT1,MD_DPD_AMT2,MD_DPD_AMT3,MD_DPD_AMT4,MD_RETAIL_BAL,MD_RENEW_DT,MD_PAST_DUE,
		  MD_OVER_LMT_CNT_L1M,
		  MD_PREV_DELI,MD_PREV_BAL_OS,MD_PREV_CRDT_LMT,MD_LN_SUPP_IND,MD_SUPP_CNT,
		  MD_AKPK,MD_WATCHLIST_FLAG,MD_WATCH_DATE,MD_NON_ACCRUAL,MD_PRINC_CARD_NO,
		  MD_SUPPL_HOLDER_NO,MD_PAYMENT,MD_CLOSED)
		  SELECT  MD_REPORT_DT,MD_ACCT_NO,MD_ACCT_ID,
          MD_ENTITY,MD_PRODUCT,MD_APPL_SYS_ID,MD_ACCT_OPEN_DT,MD_PROD_CD,MD_ACCT_STAT,
          MD_CARD_STAT,MD_CYCLE_CPS,MD_BLOCK_CD,MD_MTH_ON_BOOK,MD_LN_AGE,MD_LN_TERM,
		  MD_PRINC_LN_AMT, MD_OS_AMT,MD_LN_OPEN_DT,MD_LN_PURPOSE,MD_LN_SUB_PROD,
          MD_ACCT_TYP_CD,MD_WOFF_IND, MD_AUTO_DBT_IND,MD_CRDT_LMT,MD_CASH_ADV_LMT,
		  MD_LST_PYMT_AMT, MD_LST_CRDT_LMT_DT, MD_LST_PYMT_DT,MD_UTILIZTN,MD_INSTALL_LMT,MD_MTH_AMORT,
          MD_DPD_AMT1,MD_DPD_AMT2,MD_DPD_AMT3,MD_DPD_AMT4,MD_RETAIL_BAL,MD_RENEW_DT,MD_PAST_DUE,
		  MD_OVER_LMT_CNT_L1M,
		  MD_PREV_DELI,MD_PREV_BAL_OS,MD_PREV_CRDT_LMT,MD_LN_SUPP_IND,MD_SUPP_CNT,
		  MD_AKPK,MD_WATCHLIST_FLAG,MD_WATCH_DATE,MD_NON_ACCRUAL,MD_PRINC_CARD_NO,
		  MD_SUPPL_HOLDER_NO,MD_PAYMENT,MD_CLOSED
		  FROM MEP_DTL_CPS_EXT;
		  

UPDATE MEP_DTL_CPS
SET MD_WATCH_DATE  = '01-JAN-1901'
WHERE MD_WATCH_DATE = '01-JAN-0001';




		----------------- update md cycle     ------------------
	   /*UPDATE MTR_DTL_CPS SET MD_DPD_AMT8 = MD_DPD_AMT1
	   WHERE MD_ACCT_STAT IN ('R','W');*/
	----------------- end update md cycle ------------------
   END; -- END CPS EXTRACTION

	INSERT INTO MTR_LOG_CPS (ML_CYC_DT,ML_PROCESS_NAME,ML_RUN_START )
	VALUES  (P_DATE,'INSERT MEP_DTL_CPS FOR CPS-END',TO_CHAR(LOCALTIMESTAMP, 'DD-MON-YYYY HH:MI:SS AM') );
	
END;  -- GLOBAL END
/

