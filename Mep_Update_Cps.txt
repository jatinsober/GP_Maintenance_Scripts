------
--DEV BY : Jitendra Lodwal  
--DATE  : 06-SEP-2011 
--DESC : FUNCTION
------

SET SEARCH_PATH TO WORKAREA;

CREATE OR REPLACE FUNCTION Mep_Update_Cps() RETURNS VOID AS $$

BEGIN
BEGIN
INSERT INTO MEP_LOG_CPS (ML_PROCESS_NAME,ML_RUN_START )
VALUES  ('APR11',TO_CHAR(LOCALTIMESTAMP, 'DD-MON-YYYY HH:MI:SS AM') );
--COMMIT;
--ACCT_HT_CPS
TRUNCATE TABLE ACCT_HT_CPS;
INSERT INTO ACCT_HT_CPS
SELECT * FROM dwprod.acct_ht_1_prt_acct_ht_201104
WHERE ACCT_APPL_SYS_ID='CPS';
--COMMIT;
TRUNCATE TABLE ACCT_HT_CPS_PREV;
INSERT INTO ACCT_HT_CPS_PREV (ACCT_BUS_CYC_DT,ACCT_ACCT_ID,ACCT_ACCT_NO,ACCT_CUR_BAL)
SELECT ACCT_BUS_CYC_DT,ACCT_ACCT_ID,ACCT_ACCT_NO,ACCT_CUR_BAL
FROM dwprod.acct_ht_1_prt_acct_ht_201103
WHERE ACCT_APPL_SYS_ID='CPS';
--COMMIT;
TRUNCATE TABLE CARD_CREDIT_LINE_HT_CPS;
INSERT INTO CARD_CREDIT_LINE_HT_CPS
SELECT * FROM  dwprod.card_credit_line_ht_1_prt_card_credit_line_ht_201104
WHERE  VM_APPL_SYS_ID = 'CPS';
--COMMIT;
TRUNCATE TABLE CARD_CREDIT_LINE_HT_CPS_PREV;
INSERT INTO CARD_CREDIT_LINE_HT_CPS_PREV(VM_BUS_CYC_DT,VM_ACCT_ID,VM_APPL_SYS_ID ,VM_ACCT_NO,VM_CRLIMIT_PERM ,VM_MIA)
SELECT VM_BUS_CYC_DT,VM_ACCT_ID,VM_APPL_SYS_ID ,VM_ACCT_NO,VM_CRLIMIT_PERM ,VM_MIA
FROM  dwprod.card_credit_line_ht_1_prt_card_credit_line_ht_201103
WHERE  VM_APPL_SYS_ID = 'CPS';
--COMMIT;

TRUNCATE TABLE ACCT_ACCT_REL_CPS;

INSERT INTO ACCT_ACCT_REL_CPS(AAR_HLD_ORG_CD,AAR_ACCT_ID,AAR_R_ACCT_ID,AAR_FIN_INST_NO,AAR_APPL_SYS_ID,AAR_R_FIN_INST_NO,
AAR_R_APPL_SYS_ID ,AAR_R_ACCT_NO,AAR_EFFECTIVE_DT, AAR_EXPIRATION_DT,AAR_XFER_AMT,AAR_XFER_FREQ,
AAR_1ST_DAY_FREQ_CD,AAR_2ND_DAY_FREQ_CD,AAR_SCHED_FREQ_CD,AAR_NXT_XFER_DT,AAR_FIX_EXPR_DT_IND,
AAR_XFER_NBR,AAR_XFER_REMAIN,AAR_LST_MAINT_DT)

SELECT  AAR_HLD_ORG_CD,AAR_ACCT_ID,AAR_R_ACCT_ID,AAR_FIN_INST_NO,AAR_APPL_SYS_ID,AAR_R_FIN_INST_NO,
AAR_R_APPL_SYS_ID ,AAR_R_ACCT_NO,AAR_EFFECTIVE_DT, AAR_EXPIRATION_DT,AAR_XFER_AMT,AAR_XFER_FREQ,
AAR_1ST_DAY_FREQ_CD,AAR_2ND_DAY_FREQ_CD,AAR_SCHED_FREQ_CD,AAR_NXT_XFER_DT,AAR_FIX_EXPR_DT_IND,
AAR_XFER_NBR,AAR_XFER_REMAIN,AAR_LST_MAINT_DT FROM DWPROD.ACCT_ACCT_REL WHERE AAR_APPL_SYS_ID = 'CPS';
--COMMIT;


TRUNCATE TABLE MEP_TRAN_DETAIL_CPS_ME;
INSERT INTO MEP_TRAN_DETAIL_CPS_ME(TXD_ACCT_ID, TXD_ACCT_NO,TXD_CASH_AMT)
SELECT  TXD_ACCT_ID,TXD_ACCT_NO,SUM(COALESCE(TXD_CASH_AMT,0)) AS TXD_CASH_AMT
FROM DWPROD.TRAN_DETAIL
WHERE TXD_APPL_SYS_ID = 'CPS'
AND   TXD_TRAN_DT = '30-APR-2011'
AND  TXD_TRAN_CD IN ('PATM', 'PBRCHCH', 'PBRCHML', 'PPHONE', 'PAUTO', 'TOPUPMERC',
'PMTBII', 'PBRCHCQ', 'RPATM', 'RTOPUPMERC', 'RPBRCHML', 'RPBRCHCQ', 'RPPHONE', 'RPAUTO',
'RPBRCHCH' , 'RSALEIPM')
GROUP BY TXD_ACCT_ID,TXD_ACCT_NO;
--COMMIT;

INSERT INTO MEP_LOG_CPS (ML_PROCESS_NAME,ML_RUN_START )
VALUES  ('APR11',TO_CHAR(LOCALTIMESTAMP, 'DD-MON-YYYY HH:MI:SS AM') );
--COMMIT;
END;
END;

$$
LANGUAGE PLPGSQL;

