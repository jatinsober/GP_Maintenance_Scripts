------
--DEV BY : Jitendra Lodwal  
--DATE  : 25-AUG-2011 
--DESC : FUNCTION
------

SET SEARCH_PATH TO WORKAREA;

CREATE OR REPLACE FUNCTION Kpi_Run_On_Lif() RETURNS VOID AS $$
DECLARE

   err_num KPI_ERROR_LOG.ERROR_NO%TYPE;
   err_msg KPI_ERROR_LOG.ERROR_MSG%TYPE;
   err_table KPI_ERROR_LOG.ERROR_TABLE%TYPE;
   err_date KPI_ERROR_LOG.ERROR_DATE%TYPE;BEGIN

--/* INSERT SECOND RECORDS TO CUST_ACCT*/
err_table :='INSERT LIF RECORDS INTO CUST_ACCT';
INSERT INTO CUST_ACCT
	   SELECT A.CAR_A_APPL_SYS_ID, B.ACCT_CUR_BAL, B.ACCT_ACCT_NO,B.ACCT_OPEN_DT, B.ACCT_CLOSE_DT, B.ACCT_STAT_CD, A.CAR_CUST_KEY, A.CAR_PRIME_NO,B.ACCT_ACCT_ID, B.ACCT_PROD_CD,NULL, A.CAR_BUS_CYC_DT
	   		  FROM DWPROD.CUST_ACCT_REL_HT A,DWPROD.ACCT B
			  	   WHERE A.CAR_R_ACCT_ID = B.ACCT_ACCT_ID
				   AND A.CAR_BUS_CYC_DT = (SELECT DISTINCT SC_CURR_CYC FROM DWPROD.SSYSCYC WHERE SC_FREQUENCY='M')
				   		 AND A.CAR_A_APPL_SYS_ID = 'LIF';

EXCEPTION
   WHEN OTHERS THEN
      err_num := -1;
      err_msg := SUBSTR('error', 1, 100);
	  err_date := LOCALTIMESTAMP;
      INSERT INTO KPI_ERROR_LOG VALUES (err_num, err_msg,err_table,err_date);

END;
$$
LANGUAGE PLPGSQL;
