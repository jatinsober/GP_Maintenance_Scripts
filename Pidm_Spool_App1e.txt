------
--DEV BY : Jitendra Lodwal  
--DATE  : 06-SEP-2011 
--DESC : FUNCTION
------

SET SEARCH_PATH TO WORKAREA;

CREATE OR REPLACE FUNCTION Pidm_Spool_App1e (inout P_DATE DATE) RETURNS DATE AS $body$
DECLARE
cnt NUMERIC;
FILE1 TEXT;
FILE2 TEXT;
FILE3 TEXT;
FILE4 TEXT;
roc_val VARCHAR (20);
bor_val VARCHAR (150);
TRAN_DATE DATE;
SYSTEMDT VARCHAR(8);
buffer VARCHAR (1000);

BEGIN

TRUNCATE TABLE PIDM_APP1E;
TRUNCATE TABLE PIDM_AMBK_HDA_APP1E;
TRUNCATE TABLE PIDM_AMBK_NONHDA_APP1E;
TRUNCATE TABLE PIDM_AMIS_HDA_APP1E;
TRUNCATE TABLE PIDM_AMIS_NONHDA_APP1E;

BEGIN

INSERT INTO PIDM_APP1E
SELECT   
CAR_A_ACCT_NO AS ACCT_NO,
CUST_ADDR_1 AS RES_ADDR_LINE1,
CUST_ADDR_2 || CUST_ADDR_3 AS  RES_ADDR_LINE2,
CUST_ADDR_4  AS RES_ADDR_LINE3,
CUST_ADDR_5  AS RES_ADDR_LINE4, 
ACCT_POSTCODE AS RES_POSTCODE,
CUST_ADDR_1 AS MAILING_ADDR_LINE1,
CUST_ADDR_2 || CUST_ADDR_3 AS  MAILING_ADDR_LINE2,
CUST_ADDR_4  AS MAILING_ADDR_LINE3,
CUST_ADDR_5  AS MAILING_ADDR_LINE4,
ACCT_GL_GROUP_CODE AS ACCT_GL_GROUP_CODE,
CASE WHEN  CONTROL4 IN ('001','003','007','201','008') THEN 2 
WHEN  CONTROL4 IN ('002','004','013','202','009') THEN 1 END AS BANK_TYP,
ACCT_POSTCODE AS MAIL_POSTCODE,
CAR_CUST_KEY 
FROM PIDM_CAR A LEFT OUTER JOIN PIDM_CUST B ON A.CAR_CUST_KEY = B.CUST_KEY , PIDM_ACCT C
WHERE A.CAR_R_ACCT_ID = C.ACCT_ACCT_ID
AND   A.CAR_R_ACCT_ID = C.ACCT_ACCT_ID
AND   A.CAR_PRIME_NO_NEW ='Y' --ONLY  PRIMARY holder
AND (A.CAR_EXPIRATION_DT >= P_DATE OR A.CAR_EXPIRATION_DT = TO_DATE('01/01/0001','MM/DD/YYYY'));



CREATE TEMP TABLE MCD_OUTPUT_F1 (
R_ORDER NUMERIC,
COL_1 VARCHAR,
    acct_no character varying,
    res_addr_ln1 character varying,
    res_addr_ln2 character varying,
    res_addr_ln3 character varying,
    res_addr_ln4 character varying,
    res_post_code character varying,
    mail_addr_ln1 character varying,
    mail_addr_ln2 character varying,
    mail_addr_ln3 character varying,
    mail_addr_ln4 character varying,
    acct_gl_group_code character varying,
    bank_typ character varying,
    mail_post_code character varying,
    car_cust_key numeric
,COL_2 NUMERIC
) ;

FILE1 := $$/home/gpadmin/PIDM_DIR/PIDM_AMBANK_HDA_APP1E$$ ||'.txt';
	

SYSTEMDT := TO_CHAR(CURRENT_DATE,'YYYYMMDD') ;

INSERT INTO MCD_OUTPUT_F1 (R_ORDER,COL_1) VALUES (1,'0208052009123101001');

INSERT INTO PIDM_AMBK_HDA_APP1E
SELECT   ACCT_NO, RES_ADDR_LN1,RES_ADDR_LN2,RES_ADDR_LN3,RES_ADDR_LN4,RES_POST_CODE,MAIL_ADDR_LN1,MAIL_ADDR_LN2,MAIL_ADDR_LN3,MAIL_ADDR_LN4,MAIL_POST_CODE
FROM PIDM_APP1E 
WHERE  BANK_TYP = '2' AND ACCT_GL_GROUP_CODE = '011'; 

INSERT INTO MCD_OUTPUT_F1(R_ORDER,ACCT_NO ,RES_ADDR_LN1,RES_ADDR_LN2 ,RES_ADDR_LN3 ,RES_ADDR_LN4 ,RES_POST_CODE ,MAIL_ADDR_LN1,MAIL_ADDR_LN2,MAIL_ADDR_LN3,MAIL_ADDR_LN4,MAIL_POST_CODE ) VALUES(2,'ACCT_NO','RES_ADDR_LN1','RES_ADDR_LN2','RES_ADDR_LN3','RES_ADDR_LN4','RES_POST_CODE','MAIL_ADDR_LN1','MAIL_ADDR_LN2','MAIL_ADDR_LN3','MAIL_ADDR_LN4','MAIL_POST_CODE');

INSERT INTO MCD_OUTPUT_F1 (R_ORDER,ACCT_NO,RES_ADDR_LN1,RES_ADDR_LN2,RES_ADDR_LN3,RES_ADDR_LN4,RES_POST_CODE,MAIL_ADDR_LN1,MAIL_ADDR_LN2,MAIL_ADDR_LN3,MAIL_ADDR_LN4,MAIL_POST_CODE) SELECT 2,
ACCT_NO ,RES_ADDR_LN1,RES_ADDR_LN2 ,RES_ADDR_LN3 ,RES_ADDR_LN4 ,RES_POST_CODE ,MAIL_ADDR_LN1,MAIL_ADDR_LN2,MAIL_ADDR_LN3,MAIL_ADDR_LN4,MAIL_POST_CODE FROM PIDM_AMBK_HDA_APP1E;

SELECT COUNT(*)  INTO cnt  FROM PIDM_AMBK_HDA_APP1E;
INSERT INTO MCD_OUTPUT_F1 (R_ORDER,COL_2) VALUES (3,cnt);


EXECUTE 'copy (select COL_1,ACCT_NO,RES_ADDR_LN1,RES_ADDR_LN2,RES_ADDR_LN3,RES_ADDR_LN4,RES_POST_CODE,MAIL_ADDR_LN1,MAIL_ADDR_LN2,MAIL_ADDR_LN3,MAIL_ADDR_LN4,MAIL_POST_CODE,COL_2 from MCD_OUTPUT_F1 order by R_ORDER) to  ''' || FILE1 || ''';';


END;
BEGIN

FILE2 := $$/home/gpadmin/PIDM_DIR/PIDM_AMBANK_NONHDA_APP1E$$ ||'.txt';
	
SYSTEMDT := TO_CHAR(CURRENT_DATE,'YYYYMMDD') ;

CREATE TEMP TABLE MCD_OUTPUT_F2 (
R_ORDER NUMERIC,
COL_1 VARCHAR,
    acct_no character varying,
    res_addr_ln1 character varying,
    res_addr_ln2 character varying,
    res_addr_ln3 character varying,
    res_addr_ln4 character varying,
    res_post_code character varying,
    mail_addr_ln1 character varying,
    mail_addr_ln2 character varying,
    mail_addr_ln3 character varying,
    mail_addr_ln4 character varying,
    acct_gl_group_code character varying,
    bank_typ character varying,
    mail_post_code character varying,
    car_cust_key numeric
,COL_2 NUMERIC
) ;

INSERT INTO MCD_OUTPUT_F2 (R_ORDER,COL_1) VALUES (1,'0208052009123101001');

INSERT INTO PIDM_AMBK_NONHDA_APP1E
SELECT   ACCT_NO, RES_ADDR_LN1,RES_ADDR_LN2,RES_ADDR_LN3,RES_ADDR_LN4,RES_POST_CODE,MAIL_ADDR_LN1,MAIL_ADDR_LN2,MAIL_ADDR_LN3,MAIL_ADDR_LN4,MAIL_POST_CODE
FROM PIDM_APP1E 
WHERE  BANK_TYP = '2' AND (ACCT_GL_GROUP_CODE <> '011' OR ACCT_GL_GROUP_CODE IS NULL);

INSERT INTO MCD_OUTPUT_F2 (R_ORDER,ACCT_NO,RES_ADDR_LN1,RES_ADDR_LN2,RES_ADDR_LN3,RES_ADDR_LN4,RES_POST_CODE,MAIL_ADDR_LN1,MAIL_ADDR_LN2,MAIL_ADDR_LN3,MAIL_ADDR_LN4,MAIL_POST_CODE) VALUES(2,'ACCT_NO','RES_ADDR_LN1','RES_ADDR_LN2','RES_ADDR_LN3','RES_ADDR_LN4','RES_POST_CODE','MAIL_ADDR_LN1','MAIL_ADDR_LN2','MAIL_ADDR_LN3','MAIL_ADDR_LN4','MAIL_POST_CODE');

 INSERT INTO MCD_OUTPUT_F2 (R_ORDER,ACCT_NO,RES_ADDR_LN1,RES_ADDR_LN2,RES_ADDR_LN3,RES_ADDR_LN4,RES_POST_CODE,MAIL_ADDR_LN1,MAIL_ADDR_LN2,MAIL_ADDR_LN3,MAIL_ADDR_LN4,MAIL_POST_CODE) SELECT  2,ACCT_NO,RES_ADDR_LN1,RES_ADDR_LN2,RES_ADDR_LN3,RES_ADDR_LN4,RES_POST_CODE,MAIL_ADDR_LN1,MAIL_ADDR_LN2,MAIL_ADDR_LN3,MAIL_ADDR_LN4,MAIL_POST_CODE FROM PIDM_AMBK_NONHDA_APP1E;


SELECT COUNT(*) INTO cnt  FROM PIDM_AMBK_NONHDA_APP1E;
INSERT INTO MCD_OUTPUT_F2 (R_ORDER,COL_2) VALUES (3,cnt);

EXECUTE 'copy (select COL_1,ACCT_NO,RES_ADDR_LN1,RES_ADDR_LN2,RES_ADDR_LN3,RES_ADDR_LN4,RES_POST_CODE,MAIL_ADDR_LN1,MAIL_ADDR_LN2,MAIL_ADDR_LN3,MAIL_ADDR_LN4,MAIL_POST_CODE,COL_2 from MCD_OUTPUT_F2 order by R_ORDER) to  ''' || FILE2 || ''';';

END;
BEGIN



FILE3 := $$/home/gpadmin/PIDM_DIR/PIDM_AMISLAMIC_HDA_APP1E$$ ||'.txt';
	
SYSTEMDT := TO_CHAR(CURRENT_DATE,'YYYYMMDD') ;

CREATE TEMP TABLE MCD_OUTPUT_F3 (
R_ORDER NUMERIC,
COL_1 VARCHAR,
    acct_no character varying,
    res_addr_ln1 character varying,
    res_addr_ln2 character varying,
    res_addr_ln3 character varying,
    res_addr_ln4 character varying,
    res_post_code character varying,
    mail_addr_ln1 character varying,
    mail_addr_ln2 character varying,
    mail_addr_ln3 character varying,
    mail_addr_ln4 character varying,
    acct_gl_group_code character varying,
    bank_typ character varying,
    mail_post_code character varying,
    car_cust_key numeric
,COL_2 NUMERIC
) ;

INSERT INTO MCD_OUTPUT_F3 (R_ORDER,COL_1) VALUES (1,'0349052009123101001');


INSERT INTO PIDM_AMIS_HDA_APP1E
SELECT   ACCT_NO, RES_ADDR_LN1,RES_ADDR_LN2,RES_ADDR_LN3,RES_ADDR_LN4,RES_POST_CODE,MAIL_ADDR_LN1,MAIL_ADDR_LN2,MAIL_ADDR_LN3,MAIL_ADDR_LN4,MAIL_POST_CODE
FROM PIDM_APP1E 
WHERE  BANK_TYP = '1' AND ACCT_GL_GROUP_CODE = '011';

 INSERT INTO MCD_OUTPUT_F3 (R_ORDER,ACCT_NO, RES_ADDR_LN1,RES_ADDR_LN2,RES_ADDR_LN3,RES_ADDR_LN4,RES_POST_CODE,MAIL_ADDR_LN1,MAIL_ADDR_LN2,MAIL_ADDR_LN3,MAIL_ADDR_LN4,MAIL_POST_CODE) VALUES(2,'ACCT_NO','RES_ADDR_LN1','RES_ADDR_LN2','RES_ADDR_LN3','RES_ADDR_LN4','RES_POST_CODE','MAIL_ADDR_LN1','MAIL_ADDR_LN2','MAIL_ADDR_LN3','MAIL_ADDR_LN4','MAIL_POST_CODE');


INSERT INTO MCD_OUTPUT_F3 (R_ORDER,ACCT_NO, RES_ADDR_LN1,RES_ADDR_LN2,RES_ADDR_LN3,RES_ADDR_LN4,RES_POST_CODE,MAIL_ADDR_LN1,MAIL_ADDR_LN2,MAIL_ADDR_LN3,MAIL_ADDR_LN4,MAIL_POST_CODE) SELECT 2, ACCT_NO ,RES_ADDR_LN1,RES_ADDR_LN2,RES_ADDR_LN3,RES_ADDR_LN4,RES_POST_CODE,MAIL_ADDR_LN1,MAIL_ADDR_LN2,MAIL_ADDR_LN3,MAIL_ADDR_LN4,MAIL_POST_CODE FROM PIDM_AMIS_HDA_APP1E;

SELECT COUNT(*) INTO cnt FROM PIDM_AMIS_HDA_APP1E;
INSERT INTO MCD_OUTPUT_F3 (R_ORDER,COL_2) VALUES (3,cnt);


EXECUTE 'copy (select COL_1,ACCT_NO, RES_ADDR_LN1,RES_ADDR_LN2,RES_ADDR_LN3,RES_ADDR_LN4,RES_POST_CODE,MAIL_ADDR_LN1,MAIL_ADDR_LN2,MAIL_ADDR_LN3,MAIL_ADDR_LN4,MAIL_POST_CODE,COL_2 from MCD_OUTPUT_F3 order by R_ORDER) to  ''' || FILE3 || ''';';

END;
BEGIN



FILE4 := $$/home/gpadmin/PIDM_DIR/PIDM_AMISLAMIC_NONHDA_APP1E$$ ||'.txt';
	
SYSTEMDT := TO_CHAR(CURRENT_DATE,'YYYYMMDD') ;

CREATE TEMP TABLE MCD_OUTPUT_F4 (
R_ORDER NUMERIC,
COL_1 VARCHAR,
    acct_no character varying,
    res_addr_ln1 character varying,
    res_addr_ln2 character varying,
    res_addr_ln3 character varying,
    res_addr_ln4 character varying,
    res_post_code character varying,
    mail_addr_ln1 character varying,
    mail_addr_ln2 character varying,
    mail_addr_ln3 character varying,
    mail_addr_ln4 character varying,
    acct_gl_group_code character varying,
    bank_typ character varying,
    mail_post_code character varying,
    car_cust_key numeric
,COL_2 NUMERIC
) ;

INSERT INTO MCD_OUTPUT_F4 (R_ORDER,COL_1) VALUES (1,'0349052009123101001');


INSERT INTO PIDM_AMIS_NONHDA_APP1E
SELECT   ACCT_NO, RES_ADDR_LN1,RES_ADDR_LN2,RES_ADDR_LN3,RES_ADDR_LN4,RES_POST_CODE,MAIL_ADDR_LN1,MAIL_ADDR_LN2,MAIL_ADDR_LN3,MAIL_ADDR_LN4,MAIL_POST_CODE
FROM PIDM_APP1E 
WHERE  BANK_TYP = '1' AND (ACCT_GL_GROUP_CODE <> '011' OR ACCT_GL_GROUP_CODE IS NULL);

INSERT INTO MCD_OUTPUT_F4 (R_ORDER,ACCT_NO, RES_ADDR_LN1,RES_ADDR_LN2,RES_ADDR_LN3,RES_ADDR_LN4,RES_POST_CODE,MAIL_ADDR_LN1,MAIL_ADDR_LN2,MAIL_ADDR_LN3,MAIL_ADDR_LN4,MAIL_POST_CODE) VALUES(2,'ACCT_NO','RES_ADDR_LN1','RES_ADDR_LN2','RES_ADDR_LN3','RES_ADDR_LN4','RES_POST_CODE','MAIL_ADDR_LN1','MAIL_ADDR_LN2','MAIL_ADDR_LN3','MAIL_ADDR_LN4','MAIL_POST_CODE');


INSERT INTO MCD_OUTPUT_F4 (R_ORDER,ACCT_NO, RES_ADDR_LN1,RES_ADDR_LN2,RES_ADDR_LN3,RES_ADDR_LN4,RES_POST_CODE,MAIL_ADDR_LN1,MAIL_ADDR_LN2,MAIL_ADDR_LN3,MAIL_ADDR_LN4,MAIL_POST_CODE) SELECT 2,ACCT_NO,RES_ADDR_LN1,RES_ADDR_LN2,RES_ADDR_LN3,RES_ADDR_LN4, RES_POST_CODE,MAIL_ADDR_LN1,MAIL_ADDR_LN2,MAIL_ADDR_LN3,MAIL_ADDR_LN4,MAIL_POST_CODE FROM PIDM_AMIS_NONHDA_APP1E;

SELECT COUNT(*) INTO cnt  FROM PIDM_AMIS_NONHDA_APP1E;
INSERT INTO MCD_OUTPUT_F4 (R_ORDER,COL_2) VALUES (3,cnt);

EXECUTE 'copy (select COL_1,ACCT_NO, RES_ADDR_LN1,RES_ADDR_LN2,RES_ADDR_LN3,RES_ADDR_LN4,RES_POST_CODE,MAIL_ADDR_LN1,MAIL_ADDR_LN2,MAIL_ADDR_LN3,MAIL_ADDR_LN4,MAIL_POST_CODE,COL_2 from MCD_OUTPUT_F4 order by R_ORDER) to  ''' || FILE4 || ''';';


return;
END;
END;

$body$  
LANGUAGE plpgsql VOLATILE; 

