------
--DEV BY : Jitendra Lodwal  
--DATE  : 06-SEP-2011 
--DESC : FUNCTION
------

SET SEARCH_PATH TO WORKAREA;

CREATE OR REPLACE FUNCTION Mep_Update_Ims() RETURNS VOID AS $$
BEGIN
TRUNCATE TABLE MEP_ACCT_HT_IMS;
TRUNCATE TABLE MEP_ACCT_HT_IMS_PREV;
TRUNCATE TABLE MEP_RETAIL_CREDIT_LN_HT_IMS;
TRUNCATE TABLE MEP_CR_PROVISIONS_HT_IMS;
TRUNCATE TABLE MEP_CR_PROVISIONS_HT_IMS_PREV;
TRUNCATE TABLE MEP_RETAIL_CHECKING_HT_IMS;

INSERT INTO MEP_LOG_IMS (ML_PROCESS_NAME,ML_RUN_START )
VALUES  ('START_MAR11',TO_CHAR(LOCALTIMESTAMP, 'DD-MON-YYYY HH:MI:SS AM') );
--COMMIT;
INSERT INTO MEP_ACCT_HT_IMS(ACCT_BUS_CYC_DT,ACCT_ACCT_NO,ACCT_ACCT_ID,ACCT_APPL_SYS_ID,ACCT_OPEN_DT,
ACCT_STAT_CD,ACCT_NPL_STAT,ACCT_GL_GROUP_CODE,ACCT_LIMIT_AMT,ACCT_LST_ACT_DT,ACCT_CUR_BAL,
ACCT_CUST_SECTOR_CD,ACCT_PROD_CD,ACCT_TYP_CD,ACCT_ECON_SECTOR_CD,ACCT_CLOSE_DT)
SELECT ACCT_BUS_CYC_DT,ACCT_ACCT_NO,ACCT_ACCT_ID,ACCT_APPL_SYS_ID,ACCT_OPEN_DT,
ACCT_STAT_CD,ACCT_NPL_STAT,ACCT_GL_GROUP_CODE,ACCT_LIMIT_AMT,ACCT_LST_ACT_DT,ACCT_CUR_BAL,
ACCT_CUST_SECTOR_CD,ACCT_PROD_CD,ACCT_TYP_CD,ACCT_ECON_SECTOR_CD,ACCT_CLOSE_DT
FROM dwprod.acct_ht_1_prt_acct_ht_201103
WHERE ACCT_APPL_SYS_ID ='IMS';

--COMMIT;
INSERT INTO MEP_ACCT_HT_IMS_PREV(ACCT_BUS_CYC_DT,ACCT_ACCT_ID,ACCT_CUR_BAL)
SELECT ACCT_BUS_CYC_DT,ACCT_ACCT_ID,ACCT_CUR_BAL
FROM dwprod.acct_ht_1_prt_acct_ht_201102
WHERE ACCT_APPL_SYS_ID ='IMS';

--COMMIT;
INSERT INTO MEP_RETAIL_CREDIT_LN_HT_IMS(RC_BUS_CYC_DT,RC_ACCT_NO,RC_ACCT_ID,
RC_WTHDRW_LMT_1,RC_WTHDRW_LMT_2,RC_WTHDRW_LMT_3,RC_WTHDRW_LMT_4,RC_WTHDRW_LMT_5,
RC_WTHDRW_LMT_6,RC_WTHDRW_LMT_7,RC_WTHDRW_LMT_8,
RC_APPRV_LMT_1,RC_APPRV_LMT_2,RC_APPRV_LMT_3,RC_APPRV_LMT_4,RC_APPRV_LMT_5,
RC_APPRV_LMT_6,RC_APPRV_LMT_7,RC_APPRV_LMT_8,
RC_REPAYT_AMT,RC_REVIEW_DT_1,RC_SECUR_VALUE_1,RC_SECUR_VALUE_2,RC_SECUR_VALUE_3,
RC_SECUR_VALUE_4,RC_SECUR_VALUE_5,RC_SECUR_VALUE_6,RC_SECUR_VALUE_7,RC_SECUR_VALUE_8,
RC_SECUR_TYP_1,RC_RT_ADJ_1,RC_AKPK_TAG,RC_WATCHLIST_TAG,RC_IFRS_TAG,RC_RESCHED_CD,RC_OD_APP_DT1)

SELECT RC_BUS_CYC_DT,RC_ACCT_NO,RC_ACCT_ID,
RC_WTHDRW_LMT_1,RC_WTHDRW_LMT_2,RC_WTHDRW_LMT_3,RC_WTHDRW_LMT_4,RC_WTHDRW_LMT_5,
RC_WTHDRW_LMT_6,RC_WTHDRW_LMT_7,RC_WTHDRW_LMT_8,
RC_APPRV_LMT_1,RC_APPRV_LMT_2,RC_APPRV_LMT_3,RC_APPRV_LMT_4,RC_APPRV_LMT_5,
RC_APPRV_LMT_6,RC_APPRV_LMT_7,RC_APPRV_LMT_8,
RC_REPAYT_AMT,RC_REVIEW_DT_1,RC_SECUR_VALUE_1,RC_SECUR_VALUE_2,RC_SECUR_VALUE_3,
RC_SECUR_VALUE_4,RC_SECUR_VALUE_5,RC_SECUR_VALUE_6,RC_SECUR_VALUE_7,RC_SECUR_VALUE_8,
RC_SECUR_TYP_1,RC_RT_ADJ_1,RC_AKPK_TAG,RC_WATCHLIST_TAG,RC_IFRS_TAG,RC_RESCHED_CD,RC_OD_APP_DT1

FROM dwprod.retail_credit_ln_ht_1_prt_retail_credit_ln_ht_201103
WHERE RC_APPL_SYS_ID='IMS';
--COMMIT;
INSERT INTO MEP_CR_PROVISIONS_HT_IMS(IIS_BUS_CYC_DT,IIS_ACCT_ID,IIS_MOS_IN_ARREARS,IIS_INT_INC_OUTSTANDING,IIS_INT_SUSP_CLAW_BK_AMT)
SELECT IIS_BUS_CYC_DT,IIS_ACCT_ID,IIS_MOS_IN_ARREARS,IIS_INT_INC_OUTSTANDING,IIS_INT_SUSP_CLAW_BK_AMT
FROM dwprod.credit_provisions_ht_1_prt_credit_provisions_ht_201103
WHERE IIS_APPL_SYS_ID='IMS';
--COMMIT;
INSERT INTO MEP_CR_PROVISIONS_HT_IMS_PREV(IIS_BUS_CYC_DT,IIS_ACCT_ID,IIS_MOS_IN_ARREARS)
SELECT IIS_BUS_CYC_DT,IIS_ACCT_ID,IIS_MOS_IN_ARREARS
FROM dwprod.credit_provisions_ht_1_prt_credit_provisions_ht_201102
WHERE IIS_APPL_SYS_ID='IMS';
--COMMIT;


INSERT INTO  MEP_RETAIL_CHECKING_HT_IMS (CK_BUS_CYC_DT, CK_ACCT_ID,CK_ACCT_NO,CK_APPL_SYS_ID,
                                    CK_WRITE_OFF,CK_DC_COMNT_FEE,CK_WITH_TAX,CK_OTHER_CHARGES,CK_ACC_CR_INT)
SELECT CK_BUS_CYC_DT,CK_ACCT_ID,CK_ACCT_NO,CK_APPL_SYS_ID,CK_WRITE_OFF,CK_DC_COMNT_FEE,
       CK_WITH_TAX,CK_OTHER_CHARGES,CK_ACC_CR_INT
FROM dwprod.retail_checking_ht_1_prt_retail_checking_ht_201103
WHERE  CK_APPL_SYS_ID = 'IMS';
--COMMIT;


TRUNCATE TABLE MEP_PRODUCT_IMS ;
INSERT INTO MEP_PRODUCT_IMS(PROD_FIN_INST_NO ,PROD_PROD_CD, PROD_SHORT_DESC,PROD_APPL_SYS_ID)
SELECT PROD_FIN_INST_NO,PROD_PROD_CD,PROD_SHORT_DESC,PROD_APPL_SYS_ID FROM DWPROD.PRODUCT
WHERE PROD_FIN_INST_NO='001';
--COMMIT;


TRUNCATE TABLE  MEP_TRAN_DETAIL_IMS;
INSERT INTO MEP_TRAN_DETAIL_IMS(TXD_CYC_DT, TXD_ACCT_ID, TXD_APPL_SYS_ID, TXD_ACCT_NO,TXD_TRAN_DT,
TXD_TRAN_CD,TXD_CASH_AMT)
SELECT  TXD_CYC_DT, TXD_ACCT_ID, TXD_APPL_SYS_ID, TXD_ACCT_NO,TXD_TRAN_DT,TXD_TRAN_CD,
CASE WHEN  SUBSTR(TXD_TRAN_CD,1,2) = '25'  THEN SUM(COALESCE(TXD_CASH_AMT,0)) END AS TXD_CASH_AMT
FROM DWPROD.TRAN_DETAIL
WHERE TXD_APPL_SYS_ID = 'IMS'
AND   TXD_TRAN_CD <> '2502'
AND   TXD_TRAN_DT = '31-MAR-2011'
GROUP BY  TXD_CYC_DT,TXD_ACCT_ID,TXD_APPL_SYS_ID,TXD_ACCT_NO,TXD_TRAN_DT, TXD_TRAN_CD;
--COMMIT;


TRUNCATE TABLE  MEP_TRAN_IMS_TMP;

INSERT INTO MEP_TRAN_IMS_TMP(TXD_ACCT_NO,TXD_ACCT_ID,TXD_CASH_AMT)
SELECT TXD_ACCT_NO, TXD_ACCT_ID ,SUM(TXD_CASH_AMT)
FROM MEP_TRAN_DETAIL_IMS
WHERE   TXD_TRAN_CD <> '2502'
AND     SUBSTR(TXD_TRAN_CD,1,2) = '25'
GROUP BY  TXD_ACCT_NO,TXD_ACCT_ID;
--COMMIT;


INSERT INTO MEP_LOG_ALS (ML_PROCESS_NAME,ML_RUN_START )
VALUES  ('END_NOV10',TO_CHAR(LOCALTIMESTAMP, 'DD-MON-YYYY HH:MI:SS AM') );
--COMMIT;
END;

$$
LANGUAGE PLPGSQL;

