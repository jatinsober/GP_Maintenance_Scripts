------
--DEV BY : Jitendra Lodwal  
--DATE  : 06-SEP-2011 
--DESC : FUNCTION
------
------
--DEV BY : Jitendra Lodwal  
--DATE  : 15-MARCH-2012 
--DESC : FUNCTION
------
SET SEARCH_PATH TO WORKAREA;
CREATE OR REPLACE FUNCTION Mep_Cc_Cycle_Final_Output() RETURNS VOID AS $$
DECLARE 
CURR_CYC_DATE DATE ;
 CURR_PROCESS_DATE DATE;
 CURR_STAT_CD      VARCHAR(1);
 STATUS  VARCHAR(8);
 FG         VARCHAR(1);
 PROC_NAME         MEP_ERROR_LOG.MEP_PROC_NAME%TYPE;
 PROC_BUS_DATE     MEP_ERROR_LOG.MEP_PROC_BUS_DATE%TYPE;
 PROC_STATUS       MEP_ERROR_LOG.MEP_PROC_STATUS%TYPE;
 PROC_LOAD_STATUS  MEP_ERROR_LOG.MEP_PROC_LOAD_STATUS%TYPE;
 PREV_BILL_CYC     MEP_CARD_BILLCYCLE.PREV_BILL_CYC%TYPE;
 CURR_BILL_CYC     MEP_CARD_BILLCYCLE.CURR_BILL_CYC%TYPE;
 NEXT_BILL_CYC     MEP_CARD_BILLCYCLE.NEXT_BILL_CYC%TYPE;
-- SC_STAT_CD        SSYSCYCCPS.SC_STAT_CD%TYPE;
-- SC_CURR_CYC       SSYSCYCCPS.SC_STAT_CD%TYPE;
 SC_STAT_CD        MEP_SYS_CYC.SC_STAT_CD%TYPE;
 SC_CURR_CYC       MEP_SYS_CYC.SC_CURR_CYC%TYPE;
 SC_FREQUENCY      MEP_SYS_CYC.SC_FREQUENCY%TYPE;
 --MEP_NEXT_DATE     DATE;
 --MEP_STATUS        VARCHAR;
 
 BEGIN
 -- SELECT SC_CURR_CYC ,SC_STAT_CD  INTO CURR_CYC_DATE ,CURR_STAT_CD FROM MEP_SYS_CYC
 -- WHERE SC_FREQUENCY = 'D';
SELECT SC_STAT_CD  INTO CURR_STAT_CD FROM dwprod_base.SSYSCYC
WHERE SC_FREQUENCY = 'D';
SELECT SC_CURR_CYC  INTO CURR_CYC_DATE  FROM dwprod_base.SSYSCYC
WHERE SC_FREQUENCY = 'D';
TRUNCATE TABLE MEP_ERROR_LOG;
SELECT MEP_NEXT_DATE INTO    CURR_PROCESS_DATE FROM MEP_LOADDT;  
TRUNCATE TABLE MEP_ERROR_LOG;
SELECT MEP_NEXT_DATE INTO    CURR_PROCESS_DATE FROM MEP_LOADDT;  
SELECT MEP_STATUS INTO STATUS FROM MEP_LOADDT;
IF  (CURR_PROCESS_DATE <= CURR_CYC_DATE  AND CURR_STAT_CD = ' ' AND STATUS = 'STOP')
THEN
    ELSE IF  TO_CHAR(CURR_PROCESS_DATE,'DD') IN ('02','03','04','06','08','10','12','15','16','19'
,'20','22','23','25','26','28')
THEN
     UPDATE MEP_LOADDT
     SET MEP_STATUS = 'RUNNING'
     WHERE MEP_STATUS = 'STOP';
	 -- COMMIT;
PERFORM  Mep_Cps_Daily_Rawdata_Load(CURR_PROCESS_DATE);
PERFORM	 Mep_Main_Daily_Cps_Load(CURR_PROCESS_DATE);
PERFORM  Mep_Cps_Daily_Output(CURR_PROCESS_DATE);
	ELSE IF  TO_CHAR(CURR_PROCESS_DATE,'DD') IN ('01','05','07','09','11','13','14','17','18','21','24','27','29','30','31')
	THEN
	UPDATE MEP_LOADDT
    SET MEP_STATUS = 'RUNNING'
    WHERE MEP_STATUS = 'STOP';
	
    UPDATE MEP_LOADDT
    SET MEP_PREV_DATE = MEP_CURR_DATE,
    MEP_CURR_DATE = MEP_NEXT_DATE,
    MEP_NEXT_DATE = MEP_NEXT_DATE + 1;
	-- COMMIT;
	 
    UPDATE MEP_LOADDT
    SET MEP_STATUS = 'STOP'
    WHERE MEP_STATUS = 'RUNNING';
	-- COMMIT;
 
	END IF;
END IF;
END IF;
/* EXCEPTION
    WHEN OTHERS THEN
    PROC_NAME := 'UNDETERMINE ERROR';
    PROC_STATUS := -1||''||'error';
    PROC_BUS_DATE := LOCALTIMESTAMP;
    PROC_LOAD_STATUS := 'F';
    INSERT INTO MEP_ERROR_LOG(MEP_PROC_NAME, MEP_PROC_STATUS, MEP_PROC_BUS_DATE, MEP_PROC_LOAD_STATUS)
    VALUES (PROC_NAME, PROC_STATUS, PROC_BUS_DATE, PROC_LOAD_STATUS);
	-- COMMIT;
*/
END;
$$
LANGUAGE PLPGSQL;
