------
--DEV BY : Jitendra Lodwal  
--DATE  : 06-SEP-2011 
--DESC : FUNCTION
------

SET SEARCH_PATH TO WORKAREA;

CREATE OR REPLACE FUNCTION Pidm_Load () RETURNS VOID AS $$

BEGIN

TRUNCATE TABLE WORKAREA.PIDM_ACCT;
TRUNCATE TABLE WORKAREA.PIDM_CUST;
TRUNCATE TABLE WORKAREA.PIDM_CAR;
TRUNCATE TABLE WORKAREA.PIDM_CUST_PERS;
TRUNCATE TABLE WORKAREA.PIDM_NON_PERS;
TRUNCATE TABLE WORKAREA.PIDM_RETAIL_CHECKING;
TRUNCATE TABLE WORKAREA.PIDM_RETAIL_SAVING;
TRUNCATE TABLE WORKAREA.PIDM_CERT_DEPOSIT;


INSERT INTO PIDM_ACCT 
SELECT ACCT_ACCT_ID, ACCT_ACCT_NO, ACCT_APPL_SYS_ID, ACCT_FIN_INST_NO, ACCT_CUR_BAL, ACCT_SUB_TYP_ID, ACCT_FIN_CENT_OPEN,
ACCT_FIN_CENT_ASGN, ACCT_EMP_IND, ACCT_OPEN_DT, ACCT_INT_TO_DATE,ACCT_LIMIT_AMT,ACCT_STAT_CD, ACCT_ATM_IND,
ACCT_GL_GROUP_CODE,CASE WHEN ACCT_APPL_SYS_ID = 'STS'  THEN  SUBSTR(ACCT_ACCT_NO,9,3) WHEN ACCT_APPL_SYS_ID = 'IMS'  THEN  SUBSTR(ACCT_ACCT_NO,10,3) END AS  CONTROL4,
ACCT_PSR, ACCT_POSTCODE 
FROM dwprod.acct_ht_1_prt_acct_ht_200912 
WHERE ACCT_APPL_SYS_ID IN ('STS','IMS');

INSERT INTO   PIDM_CUST
SELECT DISTINCT CUS_KEY, CUS_NM_LINE, CUS_HOME_PHONE_INFO, CUS_OFFICE_NO, CUS_HANDPHONE_INFO, CUS_SALUTATION,CUS_CITIZEN_IND,
CUS_ADDR_1,CUS_ADDR_2,CUS_ADDR_3,CUS_ADDR_4,CUS_ADDR_5,CUS_ID_TYPE,CUS_SUB_TYP_CODE,CUS_TYP_CD
FROM dwprod.cust_ht_1_prt_cust_ht_200912
,PIDM_CAR 
WHERE CUS_KEY = CAR_CUST_KEY ;


--INSERT INTO PIDM_CAR
--SELECT CAR_A_APPL_SYS_ID, CAR_CUST_KEY, CAR_R_ACCT_ID, CAR_PRIMARY_ID, CAR_C_CIF_NO, CAR_A_ACCT_NO, CAR_REL_TYP_CD
--from CUST_ACCT_REL_HT  PARTITION(CAR_DEC09_ME) where CAR_A_APPL_SYS_ID IN ('STS', 'IMS');


INSERT INTO  PIDM_CAR
SELECT CAR_A_APPL_SYS_ID, CAR_CUST_KEY, CAR_R_ACCT_ID, CAR_PRIMARY_ID, CAR_C_CIF_NO, CAR_A_ACCT_NO, CAR_REL_TYP_CD,
CAR_PRIME_NO, CASE  WHEN CAR_REL_TYP_CD NOT IN ('04','54','55','59')
THEN CAR_PRIME_NO 
END AS CAR_PRIME_NO_NEW, CAR_EXPIRATION_DT
FROM dwprod.cust_acct_rel_ht_1_prt_cust_acct_rel_ht_200912 WHERE CAR_A_APPL_SYS_ID IN ('STS', 'IMS');



INSERT INTO PIDM_CUST_PERS
SELECT DISTINCT PER_CUST_KEY,PER_CUST_DOB,PER_SEX_CD,PER_ETHNIC_IND_CD FROM  dwprod.cust_pers_ht_1_prt_cust_pers_ht_200912
,PIDM_CAR 
WHERE CAR_CUST_KEY = PER_CUST_KEY;

INSERT INTO PIDM_NON_PERS
SELECT DISTINCT NP_CUST_KEY,NP_CUST_DOI FROM dwprod.cust_non_pers_ht_1_prt_cust_non_pers_ht_200912
,PIDM_CAR 
WHERE CAR_CUST_KEY = NP_CUST_KEY;


INSERT INTO PIDM_RETAIL_CHECKING
SELECT CK_APPL_SYS_ID, CK_ACCT_ID, CK_AVL_BAL, CK_WRITE_OFF
FROM  dwprod.retail_checking_ht_1_prt_retail_checking_ht_200912;


INSERT INTO PIDM_RETAIL_SAVING
SELECT RS_APPL_SYS_ID , RS_ACCT_ID, RS_AVL_BAL,RS_TOT_INT_PAID,RS_LST_INT_DT FROM dwprod.retail_saving_ht_1_prt_retail_saving_ht_200912
WHERE RS_APPL_SYS_ID IN ('STS','IMS');


INSERT INTO  PIDM_CERT_DEPOSIT
SELECT CD_ACCT_ID, CD_APPL_SYS_ID , CD_INT_REDEP_NOTWT, CD_FDR_RECEIPT, CD_LST_REN_DT, CD_IP_CUR_ANNL_RT,CD_CERT_TRM,
CD_NEXT_REN_DT,CD_LST_INT_PD_DT,CD_RATE_ADJ,CD_MAT_DT
FROM  dwprod.cert_deposit_ht_1_prt_cert_deposit_ht_200912 WHERE CD_APPL_SYS_ID IN ('STS','IMS'); 


--STS 03 CLOSED,04 TERMINATED,05 PURGE
DELETE FROM PIDM_ACCT
WHERE ACCT_APPL_SYS_ID='STS'
AND ACCT_STAT_CD IN ('03','04','05')
AND ACCT_CUR_BAL =0;



--IMS 03 CLOSING ONLY DEBITS ALLOWED PURGED AT ZERO BALANCE,
--04 CLOSED ZERO BALANCE,05 PURGE,08 TERMINATED
DELETE FROM PIDM_ACCT
WHERE ACCT_APPL_SYS_ID='IMS'
AND ACCT_STAT_CD IN ('03','04','05','08')
AND ACCT_CUR_BAL =0;


-- update primary type based on the customer types codes and relationship codes 
--04 business enterprise 
UPDATE PIDM_CAR
SET CAR_PRIME_NO_NEW='Y'
WHERE CAR_REL_TYP_CD='04'
AND CAR_CUST_KEY IN (SELECT CUST_KEY
FROM PIDM_CUST
WHERE CUST_SUB_TYP_CODE NOT IN ('01','99'));




--54 partnership
UPDATE PIDM_CAR
SET CAR_PRIME_NO_NEW='Y'
WHERE CAR_REL_TYP_CD='54'
AND CAR_CUST_KEY IN (SELECT CUST_KEY
FROM PIDM_CUST
WHERE CUST_SUB_TYP_CODE NOT IN ('01','99')); 




--55 sole proprietor 
UPDATE PIDM_CAR
SET CAR_PRIME_NO_NEW='Y'
WHERE CAR_REL_TYP_CD='55'
AND CAR_CUST_KEY IN (SELECT CUST_KEY
FROM PIDM_CUST
WHERE CUST_SUB_TYP_CODE NOT IN ('01','99'));


 
 --59 CLUB,ASSOCIATION & SOCIETY  
UPDATE PIDM_CAR
SET CAR_PRIME_NO_NEW='Y'
WHERE CAR_REL_TYP_CD='59'
AND CAR_CUST_KEY IN (SELECT CUST_KEY
FROM PIDM_CUST
WHERE CUST_SUB_TYP_CODE NOT IN ('01','99'));



END;
$$
LANGUAGE PLPGSQL;

