------
--DEV BY : Jitendra Lodwal  
--DATE  : 26-AUG-2011 
--DESC : FUNCTION
------

SET SEARCH_PATH TO WORKAREA;

CREATE OR REPLACE FUNCTION PROD_CTSM_ME() RETURNS VOID AS $$ 
DECLARE
PREV_DT        DATE ;
CURR_DT        DATE ;
NEXT_DT        DATE ; 
REPORT_DT_FLG VARCHAR(1);
REPORT_DT DATE;
       TOL_CR            NUMERIC;
       TOL_DB            NUMERIC;
       TXD_ID            VARCHAR(15);
X record;
--CREATED BY EVON 19JAN2010
BEGIN 

   --REPORT_DT := '30-APR-2010';   To_char(30-APR-2010,'dd-mon-yyyy');
REPORT_DT := To_date('30-APR-2010','dd-mon-yyyy');  

 TRUNCATE TABLE CTSM;
   TRUNCATE TABLE CTSM_TXD;
   TRUNCATE TABLE CTSM_TXD_SUM;
   INSERT INTO CTSM
   SELECT DISTINCT ACCT_BUS_CYC_DT,'CA',CAR_CUST_KEY, CAR_C_CIF_NO,ACCT_ACCT_NO,ACCT_ACCT_ID,CUS_NM_LINE,
          CAR_PRIMARY_ID,ACCT_ECON_SECTOR_CD,ACCT_RM_CODE,ACCT_OPEN_DT,ACCT_STAT_CD,
          NP_CUST_DOI,ACCT_LIMIT_AMT,0,0,ACCT_CUR_BAL
   FROM   dwprod.acct_ht_1_prt_acct_ht_201004,dwprod.cust_acct_rel_ht_1_prt_cust_acct_rel_ht_201004 
         LEFT OUTER JOIN  dwprod.cust_ht_1_prt_cust_ht_201004 ON CAR_CUST_KEY =CUS_KEY  
	LEFT OUTER JOIN dwprod.cust_non_pers_ht_1_prt_cust_non_pers_ht_201004 ON CAR_CUST_KEY = NP_CUST_KEY
   WHERE   ACCT_ACCT_ID =CAR_R_ACCT_ID
   AND    ACCT_APPL_SYS_ID ='IMS'
   AND    CUS_TYP_CD ='O';  


   --COMMIT;
   INSERT INTO CTSM
   SELECT DISTINCT ACCT_BUS_CYC_DT,'FD',CAR_CUST_KEY, 
          CAR_C_CIF_NO,A.ACCT_ACCT_NO,A.ACCT_ACCT_ID,CUS_NM_LINE,
          CAR_PRIMARY_ID,A.ACCT_ECON_SECTOR_CD,
          A.ACCT_RM_CODE,A.ACCT_OPEN_DT,A.ACCT_STAT_CD,
          NP_CUST_DOI,A.ACCT_LIMIT_AMT,0,0,A.ACCT_CUR_BAL
   FROM   CTSM C, dwprod.acct_ht_1_prt_acct_ht_201004 A,dwprod.cust_acct_rel_ht_1_prt_cust_acct_rel_ht_201004 
         LEFT OUTER JOIN  dwprod.cust_ht_1_prt_cust_ht_201004 ON CAR_CUST_KEY =CUS_KEY  
	LEFT OUTER JOIN dwprod.cust_non_pers_ht_1_prt_cust_non_pers_ht_201004 ON CAR_CUST_KEY = NP_CUST_KEY
   WHERE  C.CUSTOMER_KEY =CAR_CUST_KEY 
   AND    ACCT_ACCT_ID =CAR_R_ACCT_ID
   AND    ACCT_APPL_SYS_ID ='STS'
   AND    SUBSTR(ACCT_ACCT_NO , 9,3) IN ('003','004','013')
   AND    CUS_TYP_CD ='O';
   --COMMIT;
  

   INSERT INTO CTSM_TXD 
   SELECT TXD_ACCT_ID ,TXD_CYC_DT, sum(foo.SUM_DB) AS TOT_DB, sum(foo.SUM_CR) AS TOT_CR
   FROM (
   SELECT TXD_ACCT_ID ,TXD_CYC_DT,
   0 as SUM_DB,count(TXD_DR_CR_INQ_TYP) AS SUM_CR
   FROM DWPROD.TRAN_DETAIL ,CTSM
   WHERE ACCT_ID = TXD_ACCT_ID
   AND TXD_APPL_SYS_ID = 'IMS'
   AND TXD_DR_CR_INQ_TYP IN ('1','2')
   --and TXD_ACCT_ID ='1480362'
   --AND TXD_CYC_DT BETWEEN REPORT_DT-59  AND REPORT_DT 
   GROUP BY TXD_ACCT_ID,TXD_CYC_DT
   union
   SELECT TXD_ACCT_ID ,TXD_CYC_DT,
   count(TXD_DR_CR_INQ_TYP) AS SUM_DB,0 AS SUM_CR
   FROM DWPROD.TRAN_DETAIL ,CTSM
   WHERE ACCT_ID = TXD_ACCT_ID
   AND TXD_APPL_SYS_ID = 'IMS'
   AND TXD_DR_CR_INQ_TYP IN ('3','4')
   --and TXD_ACCT_ID ='1480362'
   --AND TXD_CYC_DT BETWEEN REPORT_DT-59  AND REPORT_DT
   GROUP BY TXD_ACCT_ID,TXD_CYC_DT) as foo
   GROUP BY TXD_ACCT_ID,TXD_CYC_DT;


  --COMMIT;
   INSERT INTO CTSM_TXD 
   SELECT TXD_ACCT_ID ,TXD_CYC_DT,sum(foo.SUM_DB) AS TOT_DB, sum(foo.SUM_CR) AS TOT_CR
   FROM (
   SELECT TXD_ACCT_ID ,TXD_CYC_DT,
   0 as SUM_DB,count(TXD_DR_CR_INQ_TYP) AS SUM_CR
   FROM DWPROD.TRAN_DETAIL ,CTSM
   WHERE ACCT_ID = TXD_ACCT_ID
   AND TXD_APPL_SYS_ID = 'STS'
   AND TXD_DR_CR_INQ_TYP =2
  GROUP BY TXD_ACCT_ID,TXD_CYC_DT
   union
   SELECT TXD_ACCT_ID ,TXD_CYC_DT,
   count(TXD_DR_CR_INQ_TYP) AS SUM_DB,0 AS SUM_CR
   FROM DWPROD.TRAN_DETAIL ,CTSM
   WHERE ACCT_ID = TXD_ACCT_ID
   AND TXD_APPL_SYS_ID = 'STS'
   AND TXD_DR_CR_INQ_TYP =1
   GROUP BY TXD_ACCT_ID,TXD_CYC_DT) as foo
   GROUP BY TXD_ACCT_ID,TXD_CYC_DT;
  
 --COMMIT;
   insert into CTSM_TXD_SUM
   SELECT TXD_ACCT_ID,SUM(TOT_DB) ,SUM(TOT_CR)
   FROM CTSM_TXD
   WHERE TXD_CYC_DT >= REPORT_DT-59  AND TXD_CYC_DT <= REPORT_DT
   GROUP BY TXD_ACCT_ID;
   --COMMIT;
   
UPDATE CTSM  SET TOT_DB =(SELECT a.TOT_DB                                                                                                   
FROM CTSM_TXD_SUM a, CTSM b                                                                                                                           
 WHERE a.TXD_ACCT_ID = b.ACCT_ID );

 --COMMIT;
   UPDATE CTSM C SET TOT_CR =(SELECT a.TOT_CR
   FROM CTSM_TXD_SUM a,CTSM b
   WHERE a.TXD_ACCT_ID =b.ACCT_ID );
   
--COMMIT;
 
       FOR X IN  
          (SELECT TXD_ACCT_ID , count(foo.SUM_DB) AS TOT_DB, count(foo.SUM_CR) AS TOT_CR
          FROM (
          SELECT TXD_ACCT_ID ,
          0 as SUM_DB,count(TXD_DR_CR_INQ_TYP) AS SUM_CR
          FROM DWPROD.TRAN_DETAIL ,CTSM
          WHERE ACCT_ID = TXD_ACCT_ID
		  AND TXD_APPL_SYS_ID = 'IMS'
          AND TXD_DR_CR_INQ_TYP IN ('1','2')
          --and TXD_ACCT_ID ='1480362'
          AND TXD_CYC_DT BETWEEN REPORT_DT-59  AND REPORT_DT 
          GROUP BY TXD_ACCT_ID
          union
          SELECT TXD_ACCT_ID ,
          count(TXD_DR_CR_INQ_TYP) AS SUM_DB,0 AS SUM_CR
          FROM DWPROD.TRAN_DETAIL ,CTSM
          WHERE ACCT_ID = TXD_ACCT_ID
		  AND TXD_APPL_SYS_ID = 'IMS'
          AND TXD_DR_CR_INQ_TYP IN ('3','4')
          --and TXD_ACCT_ID ='1480362'
         AND TXD_CYC_DT BETWEEN REPORT_DT-59  AND REPORT_DT
         GROUP BY TXD_ACCT_ID) as foo
         GROUP BY TXD_ACCT_ID)
       LOOP 
           TOL_DB := X.TOT_DB;
           TOL_CR :=X.TOT_CR;
           TXD_ID :=X.TXD_ACCT_ID;
       UPDATE CTSM 
       SET TOT_DB=TOL_DB ,TOT_CR=TOL_CR
       WHERE ACCT_ID =TXD_ID;
	   --COMMIT;
       --INSERT 1ST ONLY UPDATE TRAN_DETAIL 
       END LOOP ;   

    --END IF ;  
END ;

$$
LANGUAGE PLPGSQL;

