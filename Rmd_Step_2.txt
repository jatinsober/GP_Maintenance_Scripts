------
--DEV BY : Jitendra Lodwal  
--DATE  : 25-SEP-2011 
--DESC : FUNCTION
------

SET SEARCH_PATH TO RISK;

CREATE OR REPLACE Function Rmd_Step_2(RERUN_DATE IN DATE) RETURNS VOID AS $$
DECLARE

/********************************AMENDMENT LOG******************************************/

--/*   NAME      DATE            DETAILS 
      -----     -----           --------
--/*                            
--/* AMYLIA     02/06/2008      -- insert / update adm_admin even the process not done
	 							-- log found in adm_process_log  (for monitoring)   		  		  			  
--/* AMYLIA 	20/06/2008      -- AMENDED TO GET SINGLE ROW OF DATE 
--/* AMYLIA     09/07/2008      -- DISABLE THE ADM_ADMIN UPDATE SCRIPT SINCE THE PROCESS NOW OK 

/*********************************THE END**********************************************/

	   TOTAL_RECORD INTEGER;
	   NN_RECORD INTEGER;
	   COUNT_BD INTEGER;
	   EXT_BUS_DATE DATE;
	   NEXT_PROCESS_DATE DATE;
	   CHECK_BS_STATUS VARCHAR(4);
   	   PRO_NAME        ADM_PROCESS_LOG.APL_PRO_NAME%TYPE;
	   PRO_STATUS      ADM_PROCESS_LOG.APL_PRO_STATUS%TYPE;
	   PRO_BUS_DATE    ADM_PROCESS_LOG.APL_PRO_BUS_DATE%TYPE;
	   PRO_LOAD_STATUS ADM_PROCESS_LOG.APL_LOAD_STATUS%TYPE;
	   PRO_SYSTEM_DATE ADM_PROCESS_LOG.APL_SYSTEM_DATE%TYPE;
	   SYS_DATE DATE;
	   COUNT_STS INTEGER;
	   LOAD_STS VARCHAR(4);
	   ERR_VAL INT;
	   NEXT_PROCESS_DAY VARCHAR(30);
BEGIN

	 /*TRUNCATE ADM_ERROR_LOG*/
	 TRUNCATE TABLE ADM_ERROR_LOG;

			 /*DAILY PROCESS*/
			 /*THIS PART ONLY FOR GLOBUS AND CAD (DAILY PROCESS)*/

/*GET SYSTEM DATE*/
SELECT CURRENT_DATE INTO SYS_DATE;
/*CHECK BUS_DATE WITH NEXT_PROCESSING_DATE */
SELECT DISTINCT ASI_BUS_DATE AS ASI_BUS_DATE_VAL INTO EXT_BUS_DATE 
FROM ADM_SOURCE_INFO WHERE TRIM(ASI_APPL_ID) IN ('GLO')
AND ASI_BUS_DATE IS NOT NULL;-- AMYLIA AMENDED TO GET SINGLE ROW OF DATE


NEXT_PROCESS_DATE := RERUN_DATE;

IF(NEXT_PROCESS_DATE = EXT_BUS_DATE) THEN
     /*CONTINUE*/
 /*LOAD DATA FROM EXTERNAL TABLE TO STAGING*/

 /*INSERT INTO ADM_PROCESS_LOG*/
 PRO_NAME := 'LOAD EXTERNAL TABLE INTO STAGING TABLE';
 PRO_STATUS := 'START LOADING';
 PRO_BUS_DATE := RERUN_DATE;
 PRO_LOAD_STATUS := 'TRUE';
 PRO_SYSTEM_DATE := Get_Current_Date(SYS_DATE);

 INSERT INTO ADM_PROCESS_LOG
 (APL_PRO_NAME, APL_PRO_STATUS, APL_PRO_BUS_DATE, APL_LOAD_STATUS, APL_SYSTEM_DATE)
 VALUES	(PRO_NAME, PRO_STATUS, PRO_BUS_DATE, PRO_LOAD_STATUS, PRO_SYSTEM_DATE);

 /*TRUNCATE TABLE ADM_EXT_TO_STG_LOG*/
TRUNCATE TABLE ADM_EXT_TO_STG_LOG;

 /*PUT ALL THE LOADING SCRIPT*/

    --select Rmd_Load_Globus_Amm();
 --Rmd_Load_Sierra();
 --Rmd_Load_Riskwatch();
 /*Put Riskwatch script here!!!!*/
 --Rmd_Load_Globus_Amb();

 /*INSERT INTO ADM_PROCESS_LOG*/
 PRO_NAME := 'LOAD EXTERNAL TABLE INTO STAGING TABLE';
 PRO_STATUS := 'END LOADING';
 PRO_BUS_DATE := RERUN_DATE;
 PRO_LOAD_STATUS := 'TRUE';
 PRO_SYSTEM_DATE := Get_Current_Date(SYS_DATE);

 INSERT INTO ADM_PROCESS_LOG
 (APL_PRO_NAME, APL_PRO_STATUS, APL_PRO_BUS_DATE, APL_LOAD_STATUS, APL_SYSTEM_DATE)
 VALUES	(PRO_NAME, PRO_STATUS, PRO_BUS_DATE, PRO_LOAD_STATUS, PRO_SYSTEM_DATE);

 /*BEFORE LOAD DATA INTO FINAL TABLE, HAVE TO CHECK ALL EXT TO STG LOADING STATUS*/

SELECT COUNT(DISTINCT ETS_LOAD_STATUS) INTO COUNT_STS FROM ADM_EXT_TO_STG_LOG ;
 IF(COUNT_STS < 2) THEN
 	  SELECT DISTINCT ETS_LOAD_STATUS INTO LOAD_STS FROM ADM_EXT_TO_STG_LOG ;
	  IF(LOAD_STS = 'TRUE') THEN
	       /*START LOADING DATA INTO FINAL TABLE*/
 PRO_NAME := 'LOAD DATA INTO FINAL TABLE';
 PRO_STATUS := 'START';
 PRO_BUS_DATE := RERUN_DATE;
 PRO_LOAD_STATUS := 'TRUE';
 PRO_SYSTEM_DATE := Get_Current_Date(SYS_DATE);

 INSERT INTO ADM_PROCESS_LOG
 (APL_PRO_NAME, APL_PRO_STATUS, APL_PRO_BUS_DATE, APL_LOAD_STATUS, APL_SYSTEM_DATE)
 VALUES	(PRO_NAME, PRO_STATUS, PRO_BUS_DATE, PRO_LOAD_STATUS, PRO_SYSTEM_DATE);

 /*PUT ALL LOADING CODE HERE*/

 SELECT Rmd_Prc_Borrower_Daily(RERUN_DATE);
 SELECT Rmd_Prc_Debt_Sec(RERUN_DATE);
 SELECT Rmd_Prc_Mmdeals(RERUN_DATE);
 SELECT Rmd_Prc_Mmplcmnt(RERUN_DATE);
 SELECT Rmd_Prc_Sec_Forex(RERUN_DATE);
 /*need to change rmd_prc_borrower(rerun_date)*/

/*PUT ALL GLOBUS CODE HERE!!!!*/


 /*CHECK LOADING PROCESS*/
 SELECT COUNT(*) AS CNT_ERR INTO ERR_VAL FROM ADM_ERROR_LOG;

 IF(ERR_VAL = 0) THEN
     /*END LOADING DATA INTO FINAL TABLE*/
 PRO_NAME := 'LOAD DATA INTO FINAL TABLE';
 PRO_STATUS := 'END';
 PRO_BUS_DATE := RERUN_DATE;
 PRO_LOAD_STATUS := 'TRUE';
 PRO_SYSTEM_DATE := Get_Current_Date(SYS_DATE);

 INSERT INTO ADM_PROCESS_LOG
 (APL_PRO_NAME, APL_PRO_STATUS, APL_PRO_BUS_DATE, APL_LOAD_STATUS, APL_SYSTEM_DATE)
 VALUES	(PRO_NAME, PRO_STATUS, PRO_BUS_DATE, PRO_LOAD_STATUS, PRO_SYSTEM_DATE);

 /*UPDATE NEXT_PROCESSING_DATE = LAST_PROCESSING_DATE + 1*/
UPDATE ADM_ADMIN SET NEXT_PROCESSING_DATE = LAST_PROCESSING_DATE + 1
WHERE NEXT_PROCESSING_DATE IS NULL;

INSERT INTO ADM_ADMIN (LAST_PROCESSING_DATE) SELECT MAX(LAST_PROCESSING_DATE)+1 FROM ADM_ADMIN; -- ORI , AMENDED 3RD TIME 

 ELSE
      /*END LOADING DATA INTO FINAL TABLE*/
  PRO_NAME := 'LOAD DATA INTO FINAL TABLE';
  PRO_STATUS := 'NOT COMPLETE';
  PRO_BUS_DATE := RERUN_DATE;
  PRO_LOAD_STATUS := 'FALSE';
PRO_SYSTEM_DATE := Get_Current_Date(SYS_DATE);

  INSERT INTO ADM_PROCESS_LOG
(APL_PRO_NAME, APL_PRO_STATUS, APL_PRO_BUS_DATE, APL_LOAD_STATUS, APL_SYSTEM_DATE)
  VALUES	(PRO_NAME, PRO_STATUS, PRO_BUS_DATE, PRO_LOAD_STATUS, PRO_SYSTEM_DATE);
 END IF;

	  ELSE
	       /*UNABLE TO LOAD DATA INTO FINAL TABLE*/
	       /*START LOADING DATA INTO FINAL TABLE*/
 PRO_NAME := 'UNABLE TO LOAD DATA INTO FINAL TABLE. PLEASE CHECK ADM_EXT_TO_STG_LOG TABLE';
 PRO_STATUS := 'FAIL';
 PRO_BUS_DATE := RERUN_DATE;
 PRO_LOAD_STATUS := 'FALSE';
 PRO_SYSTEM_DATE := Get_Current_Date(SYS_DATE);

 INSERT INTO ADM_PROCESS_LOG
 (APL_PRO_NAME, APL_PRO_STATUS, APL_PRO_BUS_DATE, APL_LOAD_STATUS, APL_SYSTEM_DATE)
 VALUES	(PRO_NAME, PRO_STATUS, PRO_BUS_DATE, PRO_LOAD_STATUS, PRO_SYSTEM_DATE);
	  END IF;
 ELSE
 	 /*UNABLE TO LOAD DATA INTO FINAL TABLE*/
	       /*START LOADING DATA INTO FINAL TABLE*/
 PRO_NAME := 'UNABLE TO LOAD DATA INTO FINAL TABLE. PLEASE CHECK ADM_EXT_TO_STG_LOG TABLE';
 PRO_STATUS := 'FAIL';
 PRO_BUS_DATE := RERUN_DATE;
 PRO_LOAD_STATUS := 'FALSE';
 PRO_SYSTEM_DATE := Get_Current_Date(SYS_DATE);

 INSERT INTO ADM_PROCESS_LOG
 (APL_PRO_NAME, APL_PRO_STATUS, APL_PRO_BUS_DATE, APL_LOAD_STATUS, APL_SYSTEM_DATE)
 VALUES	(PRO_NAME, PRO_STATUS, PRO_BUS_DATE, PRO_LOAD_STATUS, PRO_SYSTEM_DATE);
 END IF;
ELSE
   /*EXIT*/
 PRO_NAME:= 'CHECK BUSINESS DATE(DAILY)';
 PRO_STATUS := 'FAIL: GLOBUS BUSINESS DATE PROBLEMS. PLEASE CHECK ADM_SOURCE_INFO';
 PRO_BUS_DATE:= RERUN_DATE;
 PRO_LOAD_STATUS := '';
 PRO_SYSTEM_DATE:= Get_Current_Date(SYS_DATE);

INSERT INTO ADM_PROCESS_LOG
 (APL_PRO_NAME, APL_PRO_STATUS, APL_PRO_BUS_DATE, APL_LOAD_STATUS, APL_SYSTEM_DATE)
VALUES	(PRO_NAME, PRO_STATUS, PRO_BUS_DATE, PRO_LOAD_STATUS, PRO_SYSTEM_DATE);
					

END IF;


EXCEPTION
     WHEN OTHERS THEN
		 /*INSERT INTO ADM_PROCESS_LOG*/
		 PRO_NAME := 'LOAD EXTERNAL TABLE INTO STAGING TABLE';
		 PRO_STATUS := '-1,error';
		 PRO_BUS_DATE := RERUN_DATE;
		 PRO_LOAD_STATUS := 'FALSE';
		 PRO_SYSTEM_DATE:= Get_Current_Date(SYS_DATE);

		 INSERT INTO ADM_PROCESS_LOG
		 (APL_PRO_NAME, APL_PRO_STATUS, APL_PRO_BUS_DATE, APL_LOAD_STATUS, APL_SYSTEM_DATE)
		 VALUES	(PRO_NAME, PRO_STATUS, PRO_BUS_DATE, PRO_LOAD_STATUS, PRO_SYSTEM_DATE);

END;
$$
LANGUAGE PLPGSQL;


