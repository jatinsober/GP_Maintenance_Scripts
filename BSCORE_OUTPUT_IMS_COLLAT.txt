------
--DEV BY : Jitendra Lodwal  
--DATE  : 06-SEP-2011 
--DESC : FUNCTION
------

SET SEARCH_PATH TO WORKAREA;

CREATE OR REPLACE FUNCTION BSCORE_OUTPUT_IMS_COLLAT(inout CURR_PROCESS_DATE DATE) RETURNS DATE AS $body$
DECLARE
cnt NUMERIC(25);
tot VARCHAR(27);
total NUMERIC(25,2);
FILE1 TEXT;
FILE2 TEXT;
buffer VARCHAR (1000);
RPT_DT DATE;
Business_Date VARCHAR(13);
Record_Count  VARCHAR(13);
HASH_Total    VARCHAR(13);
--ACCT_NO  NUMERIC(25);

BEGIN

SELECT count(ACCT_NO)  INTO  cnt FROM BSCORE_IMS_COLLAT;


	 SELECT COUNT(ACCT_NO) INTO CNT FROM BSCORE_ALS_COLLAT_FD;
CREATE TEMP TABLE MCD_OUTPUT_F1
(R_ORDER NUMERIC
, COL_1 VARCHAR(50) NULL
, COL_2 VARCHAR(50) NULL
, COL_3 VARCHAR(50) NULL
)
;
FILE1 := $$/home/gpadmin/PIDM_DIR/HBSCORE_IMS_COLLAT_$$ ||TO_CHAR(CURR_PROCESS_DATE,'YYYYMMDD')|| '.txt';
	 
INSERT INTO MCD_OUTPUT_F1 (R_ORDER,COL_1,COL_2) VALUES (1, 'BUSINESS_DATE','RECORD_COUNT');
	 INSERT INTO MCD_OUTPUT_F1 (R_ORDER,COL_1,COL_2) VALUES (2, TO_CHAR(CURR_PROCESS_DATE,'YYYYMMDD'),LPAD(CNT,10,'0'));

	EXECUTE 'copy (select COL_1,COL_2 from MCD_OUTPUT_F1 order by R_ORDER) to  ''' || FILE1 || ''';';


FILE2 := $$/home/gpadmin/PIDM_DIR/BSCORE_IMS_COLLAT_$$ ||TO_CHAR(CURR_PROCESS_DATE,'YYYYMMDD')|| '.txt';

CREATE TEMP TABLE MCD_OUTPUT_F2 (
R_ORDER NUMERIC
,ACCT_NO VARCHAR,COAR_COLL_NO VARCHAR,PROP_TYP_CD VARCHAR
);


INSERT INTO MCD_OUTPUT_F2 (ACCT_NO,COAR_COLL_NO,PROP_TYP_CD) VALUES (1,'ACCT_NO','COAR_COLL_NO','PROP_TYP_CD');

INSERT INTO MCD_OUTPUT_F2 (R_ORDER,ACCT_NO,COAR_COLL_NO,PROP_TYP_CD) SELECT 2,ACCT_NO,COAR_COLL_NO,PROP_TYP_CD FROM BSCORE_IMS_COLLAT;

EXECUTE 'copy (select ACCT_NO,COAR_COLL_NO,PROP_TYP_CD from MCD_OUTPUT_F2 order by R_ORDER) to  ''' || FILE2 || ''';';

return;
END;

$body$  
LANGUAGE plpgsql VOLATILE; 
